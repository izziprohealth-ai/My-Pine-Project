//@version=6 indicator(â€œZZ.EntryExit(score)â€,overlay = true,
max_lines_count = 500, max_labels_count = 500)

// ===================================================== // ğŸ§¾ SYMBOL
REGISTRY (ARRAY MODE) //
===================================================== var string[]
BURSA_NON_SYARIAH = array.from( // ========================= // Banking
& Finance // ========================= â€œABMBâ€,â€œAFFINâ€,â€œAMBANKâ€,â€œCIMBâ€,
â€œMAYBANKâ€, â€œHLBANKâ€,â€œHLFGâ€,â€œHLCAPâ€,â€œINSASâ€,
â€œKENANGAâ€,â€œOSKâ€,â€œRCECAPâ€,â€œMBSBâ€,â€œMNRBâ€,â€œALLIANZâ€,â€œLPIâ€,
â€œECMâ€,â€œELKDESAâ€,â€œNHBâ€,â€œN2Nâ€, â€œPBBANKâ€,

    // =========================
    // Gaming / Gambling
    // =========================
    "SPTOTO","GENTING","GENM","PANAMY","BERJAYA","BJSPORT", "MGM",

    // =========================
    // Alcohol / Tobacco
    // =========================
    "BAT", "CARLSBG", "HEIM", "CNOUHUA",

    // =========================
    // REITs (Conventional)
    // =========================
    "ARREIT","AXREIT","CMMT","HEKTAR","IGBREIT",
    "KLCC","MQREIT","PAVREIT","SUNREIT","YTLREIT",

    // =========================
    // Energy / Refining / Petrochemical
    // =========================
    "HENGYUAN","LCTITAN", "YTL",

    // =========================
    // Media / Entertainment
    // =========================
    "ASTRO","STAR","MEDIA","MEDIAC",

    // =========================
    // Food / Consumer (Non-Halal Exposure)
    // =========================
    "BJFOOD","MFLOUR","TIENWAH","MYNEWS",

    // =========================
    // Property / Leisure / Others
    // =========================
    "MULPHA","E&O","SUPERMX","DKSH","INNATURE",
    "OVH","PPHB","NORTHERN","SALIRAN", "maybulk",

    // =========================
    // ORIGINAL LIST (YOU PROVIDED)
    // =========================
    "3REN","99SMART","ADB","AEM","AEONCR","AGMO","AIM","ALCOM",
    "ALPHA","AMFIRST","AMTEL","APEX","ARMADA","ATLAN",
    "ATRIUM","AZAMJAYA","BCB","BENALEC","BESHOM","BHIC",
    "BJASSET","BJCORP","BJLAND","BNASTRA","BOXPAK","BRIGHT",
    "CAMAROE","CATCHA","COSMOS","EIB","EUROSP","FOODIE",
    "GBAY","GPACKET","HEXRTL","KHJB","KHB","LEONFB",
    "LKL","LYC","MEGAFB","MERSEC","SCICOM","SCGM",
    "THRIVEN","TNLOGIS","UCREST","WATTA","WELLCHIP",
    "WINSTAR","YTLPOWR"

) var string[] US_DOUBTFUL = array.from(
â€œGOOGLâ€,â€œAMZNâ€,â€œMETAâ€,â€œPEPâ€,â€œAMDâ€,â€œDLTRâ€,â€œJDâ€,â€œMDLZâ€,â€œMARâ€,â€œCDNSâ€ ) var
string[] US_NOT_HALAL = array.from(
â€œCOSTâ€,â€œNFLXâ€,â€œINTUâ€,â€œBKNGâ€,â€œATVIâ€,â€œNTESâ€,â€œPAYXâ€,â€œEAâ€,â€œEBAYâ€,â€œMTCHâ€,â€œTMUSâ€,
â€œCMCSAâ€,â€œHONâ€,â€œPYPLâ€,â€œADPâ€,â€œFISVâ€,â€œMRNAâ€,â€œAEPâ€,â€œKHCâ€,â€œMELIâ€,â€œEXCâ€,â€œXELâ€,
â€œPCARâ€,â€œCEGâ€,â€œVRSKâ€,â€œSIRIâ€,â€œLCIDâ€,â€œAMGNâ€,â€œINTCâ€,â€œCHTRâ€,â€œVRTXâ€,â€œABNBâ€,
â€œKDPâ€,â€œMNSTâ€,â€œWDAYâ€,â€œBIDUâ€,â€œCTSHâ€,â€œDDOGâ€,â€œZSâ€,â€œZMâ€,â€œMSFTâ€,â€œPDDâ€ ) var
string[] CRYPTO_HALAL = array.from(
â€œBTCâ€,â€œETHâ€,â€œADAâ€,â€œMATICâ€,â€œXLMâ€,â€œALGOâ€,â€œISLMâ€,â€œXTZâ€,â€œSOLâ€,â€œAVAXâ€ ) //
===================================================== // ğŸ‡ºğŸ‡¸ US SHARIAH
MASTER LIST (Zoya + Musaffa) //
===================================================== var string[]
US_SHARIAH_MASTER = array.from( // â€” Musaffa (Halal)
â€œAAPLâ€,â€œTSLAâ€,â€œNVDAâ€,â€œAVGOâ€,â€œAZNâ€,â€œCSCOâ€,â€œWBAâ€,â€œSPLKâ€,â€œASMLâ€,â€œADBEâ€,â€œGILDâ€,
â€œPANWâ€,â€œTXNâ€,â€œQCOMâ€,â€œSBUXâ€,â€œREGNâ€,â€œISRGâ€,â€œADIâ€,â€œAMATâ€,â€œMUâ€,â€œTEAMâ€,â€œORLYâ€,
â€œLRCXâ€,â€œSNPSâ€,â€œADSKâ€,â€œCTASâ€,â€œFTNTâ€,â€œCSXâ€,â€œBIIBâ€,â€œDXCMâ€,â€œMCHPâ€,â€œKLACâ€,â€œLULUâ€,
â€œNXPIâ€,â€œCRWDâ€,â€œILMNâ€,â€œMRVLâ€,â€œODFLâ€,â€œROSTâ€,â€œIDXXâ€,â€œCPRTâ€,â€œFASTâ€,â€œSGENâ€,â€œVRSNâ€,
â€œANSSâ€,â€œALGNâ€,â€œSWKSâ€,â€œDOCUâ€,â€œOKTAâ€,

    // --- Zoya (Verified pages)
    "GOOG","GOOGL","META","AMBA","AMCR","ARM","ARMK","ANET","ASAN","AZN",
    "BHP","BTG","BUD","COLD","DOCU","EA","ETNB","FTNT","GILD","KLAC","LRCX",
    "MRVL","NXPI","ODFL","ORLY","PANW","REGN","ROST","SNPS","TEAM","TXN",
    "VRSN","WMS","WMT","ZTS"

) // ===================================================== // ğŸš¨ PN17
(Main Market â€“ Financially Distressed) //
===================================================== var string[]
PN17_LIST = array.from( â€œSAPNRGâ€, // Sapura Energy Bhd â€œSCABLEâ€, //
Sarawak Cable Bhd â€œBINTAIâ€, // Bintai Kinden Corp Bhd â€œHOHUPâ€, // Ho Hup
Construction Bhd â€œPHARMAâ€, // Pharmaniaga Bhd (still PN17 despite
recovery progress) â€œCAPITALAâ€, // Capital A Bhd (approved plan, PN17
until uplifted) â€œVANTNRGâ€, // Vantris Energy â€œALAMâ€, â€œRENEUCOâ€,
â€œKHEESANâ€ )

// ===================================================== // âš ï¸ GN3 (ACE
Market â€“ Financially Distressed) //
===================================================== var string[]
GN3_LIST = array.from( â€œASDIONâ€, // Asdion Bhd â€œLAMBOâ€, // Lambo Group
Bhd â€œWAJAâ€ // Waja Konsortium Bhd )

// ===================================================== // ğŸ”Œ MASTER
CONTROL // =====================================================
groupMaster = â€˜ğŸ”Œ Master Controlâ€™

ZZ_MASTER_ON = input.bool(true, â€˜Enable ZZ Master Switchâ€™, group =
groupMaster)

showScoreTable = input.bool(true, â€œShow ZZ Score Tableâ€, group =
groupMaster) showDiagnostics = false

compactTable = input.bool(false, â€œZZ Score compact modeâ€, group =
groupMaster)

showAllSignals = input.bool(true,â€œShow Entry / ReEntry / Exit
Signalsâ€,group = groupMaster)

SESSION_SLAVE_ON = input.bool(true, â€˜Enable Session Markersâ€™, group =
groupMaster)

market = input.string(â€˜Bursaâ€™, â€˜Select Marketâ€™, options = [â€˜Bursaâ€™,
â€˜USâ€™, â€˜FCPOâ€™], group = groupMaster) //
===================================================== // ğŸ“Š SCOREBOARD
UI (POSITION & SIZE) â€” UI ONLY // SAFE TO MOVE //
===================================================== groupScoreUI = â€œğŸ“Š
ZZ Scoreboard â€¢ Layoutâ€

tablePositionInput = input.string( â€œTop Rightâ€, â€œTable Positionâ€,
options = [â€œTop Rightâ€, â€œTop Leftâ€, â€œMiddle Rightâ€,â€œMiddle Leftâ€,â€œBottom
Rightâ€, â€œBottom Leftâ€], group = groupScoreUI )

tableTextSizeInput = input.string( â€œNormalâ€, â€œTable Text Sizeâ€, options
= [â€œTinyâ€, â€œSmallâ€, â€œNormalâ€, â€œLargeâ€], group = groupScoreUI )

// ===================== // ğŸ·ï¸ MARKET TAG (ALERT USE) //
===================== string marketTag = â€˜UNKNOWNâ€™

// ===================== // ğŸŒ MARKET DETECTION (DECLARE ONCE, EARLY) //
===================== isCrypto = syminfo.type == â€˜cryptoâ€™ isFCPO =
str.contains(syminfo.tickerid, â€œ:FCPOâ€) isBursa =
str.contains(syminfo.tickerid, â€œMYXâ€) isUS = not isCrypto and not
isBursa and not isFCPO

if isCrypto marketTag := â€˜CRYPTOâ€™ else if isFCPO marketTag := â€˜FCPOâ€™
else if isBursa marketTag := â€˜BURSAâ€™ else marketTag := â€˜USâ€™

// Full contract ticker (e.g.Â BMD:FCPOQ2026) string fcpoTickerID =
syminfo.tickerid

// Extract contract code (FCPOQ2026) string fcpoContract = isFCPO ?
str.replace(fcpoTickerID, â€œBMD:â€, â€œâ€œ) : syminfo.ticker

// Extract base symbol (FCPO)

// FCPO display name (used in alerts) string fcpoDisplay = isFCPO ?
fcpoContract : syminfo.ticker

// ===================================================== // ğŸ“† Daily
Session BULL Score V2 (Intraday) // V2 = TREND Score + MARUBOZU Score //
=====================================================

// Manual override (optional) marketType = input.string(â€œAUTOâ€, â€œMarket
Typeâ€, options=[â€œAUTOâ€,â€œBURSAâ€,â€œUSâ€,â€œFCPOâ€,â€œCRYPTOâ€])

// â€” Define sessions string sessMain = â€œ0000-2359â€ // default string
sessAM = â€œ0000-0000â€ // only used for Bursa string sessPM = â€œ0000-0000â€
// only used for Bursa bool useSplitSession = false

if marketType == â€œBURSAâ€ // Bursa with lunch break (more accurate)
sessAM := â€œ0900-1230â€ sessPM := â€œ1430-1700â€ useSplitSession := true else
if marketType == â€œUSâ€ sessMain := â€œ0930-1600â€ else if marketType ==
â€œFCPOâ€ sessMain := â€œ0900-1800â€ else if marketType == â€œCRYPTOâ€ sessMain
:= â€œ0000-2359â€ else // AUTO mode (using syminfo.prefix) if
syminfo.prefix == â€œMYXâ€ sessAM := â€œ0900-1230â€ sessPM := â€œ1430-1700â€
useSplitSession := true else if syminfo.prefix == â€œNASDAQâ€ or
syminfo.prefix == â€œNYSEâ€ or syminfo.prefix == â€œAMEXâ€ sessMain :=
â€œ0930-1600â€ else sessMain := â€œ0000-2359â€

// â€” Session detection bool inSess = false bool sessStart = false

if useSplitSession bool inAM = not na(time(timeframe.period, sessAM))
bool inPM = not na(time(timeframe.period, sessPM)) inSess := inAM or
inPM sessStart := inSess and not inSess[1] else inSess := not
na(time(timeframe.period, sessMain)) sessStart := inSess and not
inSess[1]

// â€” Session OHLC trackers var float dO = na var float dH = na var float
dL = na var float dC = na

if sessStart dO := open dH := high dL := low dC := close else if inSess
dH := math.max(dH, high) dL := math.min(dL, low) dC := close

// â€” Range float d_rng = na(dH) or na(dL) ? na : math.max(dH - dL,
syminfo.mintick)

// â€” Metrics // 1) Trend score: close position in range (C near H =
strong trend)

// ===================================================== // â° FCPO
EXPIRY PARSER (AUTO) //
=====================================================

// Extract FCPO contract code, example: FCPOQ2026 â†’ Q2026 string
fcpoCode = isFCPO ? str.replace(fcpoContract, â€œFCPOâ€, â€œâ€œ) :â€â€

// Month letter â†’ month number (Bursa standard) f_fcpoMonth(string
letter) =>letter == â€œFâ€ ? 1 :letter == â€œGâ€ ? 2 :letter == â€œHâ€ ? 3 :
letter == â€œJâ€ ? 4 : letter == â€œKâ€ ? 5 : letter == â€œMâ€ ? 6 : letter ==
â€œNâ€ ? 7 : letter == â€œQâ€ ? 8 : letter == â€œUâ€ ? 9 : letter == â€œVâ€ ? 10 :
letter == â€œXâ€ ? 11 : letter == â€œZâ€ ? 12 : int(na)

// Month letter string fcpoMonthLetter = str.length(fcpoCode) >= 1 ?
str.substring(fcpoCode, 0, 1) : â€œâ€

// Year (SAFE v6) var int fcpoYear = na fcpoYear :=
str.length(fcpoCode) >= 5 ? int(str.tonumber(str.substring(fcpoCode,
1))) : na

// Month number int fcpoMonth = f_fcpoMonth(fcpoMonthLetter)

// ===================== // âš ï¸ RISK LABEL (PINE v5 SAFE) //
===================== string riskLabel = â€˜UNKNOWNâ€™ tf = timeframe.period

if tf == â€˜1â€™ or tf == â€˜3â€™ or tf == â€˜5â€™ riskLabel := â€˜SCALPâ€™ else if tf
== â€˜10â€™ or tf == â€˜15â€™ or tf == â€˜30â€™ riskLabel := â€˜INTRADAYâ€™ else
riskLabel := â€˜SWINGâ€™

// ===================================================== // BTST MARKET
LABEL (ALERT USE ONLY) //
===================================================== string
btstMarketLabel = isUS ? â€œUS BTSTâ€ : â€œBURSA BTSTâ€

// ===================================================== // ğŸ§ª AM / PM
MICRO MODULE (MARKET-AWARE) //
=====================================================

// Default OFF (safe) bool inAM_dbg = false bool inPM_dbg = false

// â€”â€”â€”â€”â€”â€“ BURSA â€”â€”â€”â€”â€”â€“ if isBursa string tzMY = â€œAsia/Kuala_Lumpurâ€ int
h = hour(time, tzMY) int m = minute(time, tzMY)

    // AM: 09:00â€“12:30
    inAM_dbg :=
         (h > 9 and h < 12) or
         (h == 9) or
         (h == 12 and m <= 30)

    // PM: 14:30â€“17:00
    inPM_dbg :=
         (h > 14 and h < 17) or
         (h == 14 and m >= 30) or
         (h == 17 and m == 0)

// â€”â€”â€”â€”â€”â€“ US â€”â€”â€”â€”â€”â€“ else if isUS string tzUS = â€œAmerica/New_Yorkâ€ int h
= hour(time, tzUS) int m = minute(time, tzUS)

    // AM: 09:30â€“12:00
    inAM_dbg :=
         (h == 9 and m >= 30) or
         (h > 9 and h < 12)

    // PM: 12:00â€“16:00
    inPM_dbg :=
         (h >= 12 and h < 16)

// â€”â€”â€”â€”â€”â€“ CRYPTO â€”â€”â€”â€”â€”â€“ else if isCrypto int h = hour(time, â€œUTCâ€)

    // AM: 00:00â€“12:00 UTC
    inAM_dbg := h < 12

    // PM: 12:00â€“24:00 UTC
    inPM_dbg := h >= 12

var float amO_dbg = na var float amH_dbg = na var float amL_dbg = na var
float amC_dbg = na

var float pmO_dbg = na var float pmH_dbg = na var float pmL_dbg = na var
float pmC_dbg = na

bool amStart_dbg = inAM_dbg and not inAM_dbg[1] bool pmStart_dbg =
inPM_dbg and not inPM_dbg[1]

// â€” AM if amStart_dbg amO_dbg := open amH_dbg := high amL_dbg := low
amC_dbg := close else if inAM_dbg amH_dbg := math.max(amH_dbg, high)
amL_dbg := math.min(amL_dbg, low) amC_dbg := close

// â€” PM if pmStart_dbg pmO_dbg := open pmH_dbg := high pmL_dbg := low
pmC_dbg := close else if inPM_dbg pmH_dbg := math.max(pmH_dbg, high)
pmL_dbg := math.min(pmL_dbg, low) pmC_dbg := close

// ===================================================== // ğŸ§  ZZ Score
Intraday Trend Score (CANONICAL â€“ SESSION ONLY) //
=====================================================
f_intradayTrendScore(_o, _h, _l, _c) => float _rng = math.max(_h - _l,
syminfo.mintick) float _pct = (_c - _l) / _rng * 100.0 string _grade =
â€œNAâ€

    if _c <= _o
        _grade := "F"
    else if _pct >= 90
        _grade := "A+"
    else if _pct >= 80
        _grade := "A"
    else if _pct >= 70
        _grade := "B"
    else if _pct >= 60
        _grade := "C"
    else if _pct >= 50
        _grade := "D"
    else
        _grade := "E"

    [_grade, _pct]

// ===================================================== // ğŸ§  ZZ
INTRADAY TREND â€” SESSION WALK MODEL (v4) // Measures progress from
session OPEN â†’ NOW //
=====================================================
f_intradayTrendScore_v4(_o, _h, _l, _c) => float sessionRange =
math.max(_h - _l, syminfo.mintick)

    // 1ï¸âƒ£ Net progress from OPEN
    float netMovePct = (_c - _o) / sessionRange * 100.0

    // 2ï¸âƒ£ Candle participation (last N candles)
    int lookback = 8
    int agree = 0

    for i = 0 to lookback - 1
        if netMovePct > 0 and close[i] > open[i]
            agree += 1
        if netMovePct < 0 and close[i] < open[i]
            agree += 1

    float participationPct = agree / lookback * 100.0

    // 3ï¸âƒ£ Final score (directional, recovery-friendly)
    float scorePct =
         math.abs(netMovePct) * 0.65 +
         participationPct     * 0.35

    scorePct := math.min(100, math.max(0, scorePct))

    // 4ï¸âƒ£ Grade (UNCHANGED SCALE)
    string grade = "E"

    if netMovePct <= 0
        grade := "F"
    else if scorePct >= 90
        grade := "A+"
    else if scorePct >= 80
        grade := "A"
    else if scorePct >= 70
        grade := "B"
    else if scorePct >= 60
        grade := "C"
    else if scorePct >= 50
        grade := "D"
    else
        grade := "E"

    [grade, scorePct]

// ===================================================== // ğŸ§  INTRADAY
COMPOSITE â€” DIRECTIONALLY SAFE (v3) // AM pullbacks do NOT kill PM
recovery // =====================================================
f_intradayTrend_from_AMPM(amPct, pmPct) => bool hasAM = not na(amPct)
bool hasPM = not na(pmPct)

    // Use absolute strength, but bias toward PM
    float amStrength = hasAM ? math.max(0, amPct) : na
    float pmStrength = hasPM ? math.max(0, pmPct) : na

    float intradayPct =
         hasAM and hasPM ? (amStrength * 0.35 + pmStrength * 0.65) :
         hasPM           ? pmStrength :
         hasAM           ? amStrength :
                           na

    string grade = "NA"

    if na(intradayPct)
        grade := "NA"
    else if intradayPct >= 85
        grade := "A+"
    else if intradayPct >= 70
        grade := "A"
    else if intradayPct >= 55
        grade := "B"
    else if intradayPct >= 40
        grade := "C"
    else if intradayPct >= 25
        grade := "D"
    else
        grade := "E"

    [grade, intradayPct]

// ===================================================== // ğŸ“Œ AM / PM
TREND SNAPSHOT (PERSISTENT) //
===================================================== var float
amTrendPct_last = na var string amTrendGrade_last = â€œNAâ€

var float pmTrendPct_last = na var string pmTrendGrade_last = â€œNAâ€ //
===================================================== // ğŸ§  INTRADAY
TREND â€” OPEN â†’ CLOSE PROGRESSION (OC) // Used by AM & PM trend engines
// =====================================================
f_intradayTrendScore_OC(_o, _h, _l, _c) => float _rng = math.max(_h -
_l, syminfo.mintick)

    // Net progress from session OPEN
    float netPct = (_c - _o) / _rng * 100.0
    netPct := math.max(netPct, -20)   // limit AM damage


    string grade = "E"

    if netPct <= 0
        grade := "F"
    else if netPct >= 70
        grade := "A+"
    else if netPct >= 55
        grade := "A"
    else if netPct >= 40
        grade := "B"
    else if netPct >= 25
        grade := "C"
    else if netPct >= 10
        grade := "D"
    else
        grade := "E"

    [grade, netPct]

// ===================================================== // ğŸ§  AM / PM
TREND SCORES (CANONICAL) //
===================================================== string
amTrendGrade = â€œNAâ€ float amTrendPct = na

string pmTrendGrade = â€œNAâ€ float pmTrendPct = na

if not na(amC_dbg) [amTrendGrade, amTrendPct] =
f_intradayTrendScore_OC(amO_dbg, amH_dbg, amL_dbg, amC_dbg)
amTrendPct_last := amTrendPct amTrendGrade_last := amTrendGrade

if not na(pmC_dbg) [pmTrendGrade, pmTrendPct] =
f_intradayTrendScore_OC(pmO_dbg, pmH_dbg, pmL_dbg, pmC_dbg)
pmTrendPct_last := pmTrendPct pmTrendGrade_last := pmTrendGrade

// Preserve AM until PM completes if not inAM_dbg and not inPM_dbg
amO_dbg := na amH_dbg := na amL_dbg := na amC_dbg := na

if not inPM_dbg pmO_dbg := na pmH_dbg := na pmL_dbg := na pmC_dbg := na

// ===================================================== // ğŸ¨ THEME
SYSTEM â€” VISUAL ONLY // ğŸš« DO NOT PLACE LOGIC BELOW //
===================================================== groupTheme = â€˜ğŸ¨
ZZ.Themeâ€™ themeMode = input.string(â€˜Darkâ€™, â€˜Chart Themeâ€™, options =
[â€˜Darkâ€™, â€˜Lightâ€™], group = groupTheme) isDark = themeMode == â€˜Darkâ€™

// â€”- Theme palette (VISUAL ONLY) colBull = isDark ? color.rgb(229, 255,
0) : color.green colBear = isDark ? color.fuchsia : color.maroon

// â€”- Label text auto-contrast labelTextCol = isDark ? color.rgb(0, 0,
0) : color.rgb(255, 255, 255)

// â€”- Semantic aliases (visual only) colEntry = colBull colExit =
colBear

// â€”- Background & bar theme colors (visual only) bgEntryCol = isDark ?
color.new(color.white, 70) : color.new(color.green, 85) bgExitCol =
isDark ? color.new(color.red, 70) : color.new(color.red, 85)

barEntryCol = isDark ? color.white : color.green

// ================================================== // ğŸ¨ SESSION
THEME (VISUAL ONLY) //
================================================== groupSessionTheme =
â€˜ğŸ¨ Bursa.US.FCPO.Themeâ€™ sessionTheme = input.string(â€˜Darkâ€™, â€˜Theme
Modeâ€™, options = [â€˜Darkâ€™, â€˜Lightâ€™], group = groupSessionTheme)
isSessDark = sessionTheme == â€˜Darkâ€™

sessTextCol = isSessDark ? color.white : color.rgb(0, 0, 0) sessLblText
= isSessDark ? color.rgb(0, 0, 0) : color.white sessVWAPCol = isSessDark
? color.yellow : color.rgb(150, 120, 0) //
===================================================== // ğŸ” GLOBAL ZZ
GATE // ===================================================== ZZ_ON =
ZZ_MASTER_ON // ===================================================== //
ğŸ›ï¸ ENGINE SELECTION (TOGGLE SWITCHES) //
===================================================== groupEngine = â€˜ğŸ›ï¸
Engine Selectionâ€™

showZZMajor = input.bool(true, â€œZZ Major Wave Lineâ€, group =
groupEngine) showZZMinorWave = input.bool(true, â€œZZ Minor Wave Lineâ€,
group = groupEngine) showEWLine = input.bool(true, â€˜ZZ Subwave Lineâ€™,
group = groupEngine) showE2So = input.bool(true, â€œE2So â¬œ| entry exit
signal momentum base |Short|Medium|Long term|â€, group = groupEngine)
showE2Su = input.bool(false, â€œE2Su ğŸŸ©| entry exit signal price base
|Medium|Long term|â€, group = groupEngine) showIBO = input.bool(false,
â€œIBO ğŸŸ¦| entry exit signal short ema base |Shortterm|â€, group =
groupEngine) showIBOBuyLevels = input.bool(true, â€˜Show IBO ğŸŸ¦| Buy 1 /
Buy 2 labelsâ€™, group = groupEngine) showBTST_PRO = input.bool(true,
â€œBTST_PRO signal ğŸŸª|Shortterm|â€, group = groupEngine) //
===================================================== // ğŸ§  ZZ CORE â€”
ENTRY / EXIT SIGNAL (NEW ENGINE) //
===================================================== groupZZCoreSignal
= â€œğŸ§  ZZ Core â€¢ Entry Exit Signalâ€

showZZCoreSignal = input.bool( true, â€œZZ Core Entry Exit Signal
ğŸŸ¥|Medium|Long term|â€, group = groupZZCoreSignal )

showZZCoreEntry = input.bool( true, â€œShow Entryâ€, group =
groupZZCoreSignal )

showZZCoreReEntry = input.bool( true, â€œShow Re-entryâ€, group =
groupZZCoreSignal )

showZZCoreExit = input.bool( true, â€œShow Exitâ€, group =
groupZZCoreSignal )

// ===================================================== // ğŸŸ£ ZZ MAJOR
V2 â€” ENTRY / EXIT SETTINGS //
===================================================== groupZZMajorV2 =
â€œğŸŒŠ ZZ Major V2 â€¢ Entry Exit Signalâ€

showZZMajorV2Signal = input.bool(false, â€œZZ Major V2 Signal
ğŸŸª|Medium|Longterm|â€, group = groupZZMajorV2) showZZMajorV2Entry =
input.bool(true, â€œShow Entryâ€, group = groupZZMajorV2) showZZMajorV2Exit
= input.bool(true, â€œShow Exitâ€, group = groupZZMajorV2)

// Exit behavior zzV2PullbackPct = input.float(3.0, â€œExit Pullback %
from Peakâ€, step = 0.1, group = groupZZMajorV2)

// ===================================================== // ğŸ›ï¸ ZZ MINOR
ENGINE (LEGACY / ORIGINAL) //
===================================================== groupZZMinor = â€œğŸŒŠ
ZZ Minor â€¢ Legacy Engineâ€

showZZMinorSignal = input.bool(true, â€œZZ Minor Entry Exit Signal
ğŸŸ¨|Shortterm|â€, group = groupZZMinor)

showZZMinorEntry = input.bool(true, â€œShow Entryâ€, group = groupZZMinor)
showZZMinorExit = input.bool(true, â€œShow Exitâ€, group = groupZZMinor)

// ===================================================== // ğŸŒŠ ZZ
Subwave CONTROLS //
===================================================== groupEWctrl = â€˜ğŸŒŠ
ZZ Subwave Controlsâ€™

showEWSignal = input.bool(true, â€˜ZZ Subwave Entry Exit Signal
ğŸŸ©|Shortterm|â€™, group = groupEWctrl) showEWEntry = input.bool(true,
â€˜Show Entryâ€™, group = groupEWctrl) showEWExit = input.bool(true, â€˜Show
Exitâ€™, group = groupEWctrl)

// ===================================================== // ENGINE FLAGS
(MAPPED 1-TO-1, NO LOGIC CHANGE) //
===================================================== zzMajorON =
showZZMajor e2suDD_ON = showE2Su e2soDD_ON = showE2So iboDD_ON = showIBO
ewLine_ON = showEWLine ewSignal_ON = showEWSignal

// ğŸ”” ALERT SYSTEM: ALWAYS ON (UNGATED)

zzLineColor_ON = color.new(#00ff00, 0) zzLineColor_OFF =
color.new(#00ff00, 100)

ema50Gate = e2suDD_ON or iboDD_ON

// ===================================================== // ZZTRADE
SETTINGS (ORIGINAL â€“ UNTOUCHED) //
===================================================== groupZZ = â€˜ZZTrade
Settingsâ€™ groupZZAdvanced = â€˜ZZTrade â€¢ Advanced (ZigZag Core)â€™

showPivotPriceLabels = input.bool(true, â€˜Pivot Price Labels ğŸŸ¥top |
ğŸŸ©bottomâ€™)

Zigzag = input.float(5, title = â€˜Deviation (%)â€™, minval = 1, maxval =
100, group = groupZZAdvanced) MAX_DEPTH = 500 // hard safety cap (well
below 1120)

dalamInput = input.int(10, title = â€˜Depthâ€™, minval = 1, maxval =
MAX_DEPTH, group = groupZZAdvanced) dalam = math.min(dalamInput,
MAX_DEPTH) // ===================================================== //
ğŸšï¸ EMA50 MASTER CONTROL //
===================================================== groupEMA = â€˜ğŸ“ EMA
Controlsâ€™

useEMA50 = input.bool(true, â€˜Enable EMA50 (Global)â€™, group = groupEMA)

// ===================== // ZIGZAG CORE LOGIC // =====================
pivots(src, length, isHigh) =>

    if bar_index < length * 2
        [int(na), float(na)]
    else
        p = src[length]
        isFound = true

        for i = 0 to length - 1 by 1
            if isHigh and src[i] > p or not isHigh and src[i] < p
                isFound := false
                isFound

        for i = length + 1 to 2 * length by 1
            if isHigh and src[i] >= p or not isHigh and src[i] <= p
                isFound := false
                isFound

        if isFound
            [bar_index[length], p]
        else
            [int(na), float(na)]

[iH, pH] = pivots(high, math.floor(dalam / 2), true) [iL, pL] =
pivots(low, math.floor(dalam / 2), false)

calc_dev(base_price, price) => 100 * (price - base_price) / base_price

var line lineLast = na var int iLast = 0 var float pLast = 0 var bool
isHighLast = true // otherwise the last pivot is a low pivot var int
linesCount = 0

pivotFound(dev, isHigh, index, price) => if index <= 0 or bar_index -
index > 1000 [line(na), bool(na), false, iLast, pLast] else if
isHighLast == isHigh and not na(lineLast) if isHighLast ? price > pLast
: price < pLast if linesCount <= 1 line.set_xy1(lineLast, index, price)
line.set_xy2(lineLast, index, price) [lineLast, isHighLast, false,
iLast, pLast] else [line(na), bool(na), false, iLast, pLast] else if
na(lineLast) id = line.new(index, price, index, price, color = ZZ_ON and
zzMajorON ? zzLineColor_ON : zzLineColor_OFF, width = 2, force_overlay =
true) [id, isHigh, true, index, price] else if math.abs(dev) >= Zigzag
id = (bar_index - iLast <= 1000) ? line.new(iLast, pLast, index, price,
color = ZZ_ON and zzMajorON ? zzLineColor_ON : zzLineColor_OFF, width =
2, force_overlay = true) : na [id, isHigh, true, index, price] else
[line(na), bool(na), false, iLast, pLast]

if not na(iH) and not na(iL) and iH == iL dev1 = calc_dev(pLast, pH)
[id2, isHigh2, isNew2] = pivotFound(dev1, true, iH, pH) if isNew2
linesCount := linesCount + 1 linesCount if not na(id2) lineLast := id2
isHighLast := isHigh2 iLast := iH pLast := pH pLast

    dev2 = calc_dev(pLast, pL)
    [id1, isHigh1, isNew1] = pivotFound(dev2, false, iL, pL)
    if isNew1
        linesCount := linesCount + 1
        linesCount
    if not na(id1)
        lineLast := id1
        isHighLast := isHigh1
        iLast := iL
        pLast := pL
        pLast

else if not na(iH) dev1 = calc_dev(pLast, pH) [id, isHigh, isNew] =
pivotFound(dev1, true, iH, pH) if isNew linesCount := linesCount + 1
linesCount if not na(id) lineLast := id isHighLast := isHigh iLast := iH
pLast := pH pLast else if not na(iL) dev2 = calc_dev(pLast, pL) [id,
isHigh, isNew] = pivotFound(dev2, false, iL, pL) if isNew linesCount :=
linesCount + 1 linesCount if not na(id) lineLast := id isHighLast :=
isHigh iLast := iL pLast := pL pLast

// ===================================================== // ğŸ§  ZZ MAJOR
WAVE â€“ PIVOT MEMORY //
===================================================== var float
zzLastMajorLow = na var float zzLastMajorHigh = na var int
zzLastPivotBar = na

if not na(iLast) if not isHighLast zzLastMajorLow := pLast
zzLastPivotBar := iLast zzLastPivotBar else zzLastMajorHigh := pLast
zzLastPivotBar := iLast zzLastPivotBar

// ===================================================== // ğŸ“ˆ EMA50
CORE (MASTER-GATED) //
===================================================== ema50_raw =
ta.ema(close, 50) ema50 = useEMA50 ? ema50_raw : na

// ===================== // EMA50 DISTANCE (%) // =====================
ema50DistPct = not na(ema50) ? (close - ema50) / ema50 * 100 : na

f_pct(x) => na(x) ? â€œN/Aâ€ : str.tostring(x, â€œ#.##â€) + â€œ%â€

// ===================================================== // ğŸ“Š VOLUME
MA50 (SHARED WITH EMA50 SPINE) //
===================================================== volMA50 =
ta.sma(volume, 50)

// ===================================================== // ğŸ§  ZZ MAJOR
â€” TREND & CANDLE HELPERS (SINGLE SOURCE) //
=====================================================

// Trend state zzTrendBull = useEMA50 and close > ema50 and ema50 >=
ema50[1] zzTrendBear = useEMA50 and close < ema50 and ema50 <= ema50[1]

// Candle intent zzBullCandle = close > open zzBearCandle = close < open

// Bull regime ONLY ema50Bull = useEMA50 and close > ema50 and ema50 >=
ema50[1]

// Volume expansion volSpike50 = volume > volMA50 * 1.5

// ZZ Major volume intent (alias) zzBullVolSpike = volSpike50

// Candle bias bullCandle = close > open

// =====================================================================
// ğŸŒŠ ZZ MAJOR V2 â€” MASTER SAFE (TOGGLE-FIXED) | Pine v6 //
=====================================================================

// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”- // ğŸ”’ INTERNAL CALCS (LOCAL / NO COLLISION) //
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”- zzm2_len = 20 zzm2_mult = 2.0

zzm2_midBB = ta.sma(close, zzm2_len) zzm2_dev = zzm2_mult *
ta.stdev(close, zzm2_len) zzm2_upperBB = zzm2_midBB + zzm2_dev
zzm2_lowerBB = zzm2_midBB - zzm2_dev

zzm2_mid2BB = (zzm2_midBB + zzm2_lowerBB) / 2.0 zzm2_mid3BB =
(zzm2_mid2BB + zzm2_lowerBB) / 2.0

zzm2_wma5l = ta.wma(low, 5) zzm2_wma5h = ta.wma(high, 5)

// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”- // ğŸŸ¢ ENTRY â€” EARLY // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”-
zzMajorV2Entry_raw = ta.crossover(zzm2_wma5l, zzm2_mid3BB)

// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”- // ğŸ”´ RED-X ZONE // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”- zzMajorV2RedX
= zzm2_wma5h >= zzm2_upperBB and high >= zzm2_upperBB

// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”- // ğŸ§  STATE MEMORY (V2 ONLY) // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”-
var bool zzMajorV2InTrade = false var float zzMajorV2Peak = na var bool
zzMajorV2Armed = false

zzMajorV2Entry = false zzMajorV2Exit = false

// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”- // ğŸŸ¢ ENTRY STATE (V2 TOGGLE-GATED) //
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”- if ZZ_ON and showZZMajorV2Signal and
zzMajorV2Entry_raw and not zzMajorV2InTrade zzMajorV2InTrade := true
zzMajorV2Peak := na zzMajorV2Armed := false zzMajorV2Entry := true

// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”- // ğŸ“ˆ TRACK HIGHEST HIGH DURING RED-X //
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”- if zzMajorV2InTrade and zzMajorV2RedX zzMajorV2Peak :=
na(zzMajorV2Peak) ? high : math.max(zzMajorV2Peak, high) zzMajorV2Armed
:= true

// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”- // ğŸ”´ EXIT â€” PULLBACK FROM RED-X PEAK //
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”- float zzMajorV2PullbackLevel = na(zzMajorV2Peak) ? na
: zzMajorV2Peak * (1.0 - zzV2PullbackPct / 100.0) bool
zzMajorV2PullbackExit = zzMajorV2InTrade and zzMajorV2Armed and not
na(zzMajorV2PullbackLevel) and close <= zzMajorV2PullbackLevel

if zzMajorV2PullbackExit zzMajorV2Exit := true zzMajorV2InTrade := false
zzMajorV2Peak := na zzMajorV2Armed := false

// ===================================================== // ğŸ‘ï¸
VISIBILITY (V2 TOGGLES â€” FIXED) //
=====================================================
zzMajorV2EntryVisible = ZZ_ON and showAllSignals and showZZMajorV2Signal
and showZZMajorV2Entry and zzMajorV2Entry

zzMajorV2ExitVisible = ZZ_ON and showAllSignals and showZZMajorV2Signal
and showZZMajorV2Exit and zzMajorV2Exit

// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”- // ğŸ¯ PLOTS (ZZ MAJOR V2) // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”-
plotshape( zzMajorV2EntryVisible, title = â€œZZ Major V2 Entryâ€, text =
â€œentryâ€, style = shape.labelup, location = location.belowbar, color =
color.purple, textcolor = labelTextCol, size = size.small, force_overlay
= true )

plotshape( zzMajorV2ExitVisible, title = â€œZZ Major V2 Exit (Pullback
from Peak)â€, text = â€œexitâ€, style = shape.labeldown, location =
location.abovebar, color = color.purple, textcolor = labelTextCol, size
= size.small, force_overlay = true )

// =====================================================================
// âœ… END â€” ZZ MAJOR V2 (TOGGLE SAFE) //
=====================================================================

// ===================== // ZIGZAG LINE PLOT // =====================
ZZPercent = input.float(0.5, title = â€˜Minimum % Changeâ€™, step = 0.1,
group = groupZZAdvanced)

trend = 0 trend := na(trend[1]) ? 1 : trend[1] LL = 0.0 LL := na(LL[1])
? low : LL[1] HH = 0.0 HH := na(HH[1]) ? high : HH[1]

PivotChg = ZZPercent * 0.01 zigzag = float(na)

if trend > 0 // trend is up, look for new swing low if high >= HH // new
higher high detected HH := high HH else if low < HH * (1 - PivotChg)
zigzag := high[1] trend := -1 LL := low LL else // trend is down, look
for new swing high if low <= LL // new lower low detected LL := low LL
else if high > LL * (1 + PivotChg) zigzag := low[1] trend := 1 HH :=
high HH

// ===================== // BULL / BEAR ARROW SWITCHES //
===================== groupZZArrows = â€˜ZZTrade â€¢ Bull / Bear Arrowsâ€™

showBullArrow = input.bool(true, â€˜Bull Arrowâ€™, group = groupZZArrows)
showBearArrow = input.bool(true, â€˜Bear Arrowâ€™, group = groupZZArrows)

BuRC = close > ((high + low) / 2)[1] and close > ((high + low) / 2)[2]
BeRC = close < ((high + low) / 2)[1] and close < ((high + low) / 2)[2]

// ===================== // BULL / BEAR ARROWS (INDEPENDENT SWITCH) //
===================== plotshape(ZZ_ON and zzMajorON and showBullArrow
and BuRC, style = shape.arrowup, location = location.belowbar, color =
colEntry, size = size.tiny, editable = true, force_overlay = true)

plotshape(ZZ_ON and zzMajorON and showBearArrow and BeRC, style =
shape.arrowdown, location = location.abovebar, color = colExit, size =
size.tiny, editable = true, force_overlay = true)

// ===================== // PIVOT PRICE LABELS // =====================
lenH = input.int(10, â€˜Length Highâ€™) lenL = input.int(10, â€˜Length Lowâ€™)

drawPivot(src, len, isHigh, style, yloc_, col) => p = nz(src[len]) ok =
true for i = 0 to len - 1 by 1 if isHigh and src[i] > p or not isHigh
and src[i] < p ok := false ok for i = len + 1 to 2 * len by 1 if isHigh
and src[i] >= p or not isHigh and src[i] <= p ok := false ok if ZZ_ON
and showAllSignals and ok and zzMajorON and showPivotPriceLabels
label.new(bar_index[len], p, str.tostring(p), style = style, yloc =
yloc_, color = col, textcolor = labelTextCol, size = size.small,
force_overlay = true)

drawPivot(high, lenH, true, label.style_label_lower_right,
yloc.abovebar, #ff0000) drawPivot(low, lenL, false,
label.style_label_upper_right, yloc.belowbar, #00ff00)

// ===================== // SUPPORT / RESISTANCE LEVELS //
===================== showRSLevels = input.bool(true, â€˜Auto Support and
Resistant Levelsâ€™, group = groupZZ)

W1 = input(title = â€˜type1â€™, defval = 8) W2 = input(title = â€˜type2â€™,
defval = 21)

R1 = ta.valuewhen(high >= ta.highest(high, W1), high, 0) S1 =
ta.valuewhen(low <= ta.lowest(low, W1), low, 0) R2 =
ta.valuewhen(high >= ta.highest(high, W2), high, 0) S2 =
ta.valuewhen(low <= ta.lowest(low, W2), low, 0)

Res1 = plot(ZZ_ON and showRSLevels ? R1 : na, color = R1 != R1[1] ? na :
#00ff00, editable = true, force_overlay = true) Sup1 = plot(ZZ_ON and
showRSLevels ? S1 : na, color = S1 != S1[1] ? na : #ff0000, editable =
true, force_overlay = true) Res2 = plot(ZZ_ON and showRSLevels ? R2 :
na, color = R2 != R2[1] ? na : #00ff00, editable = true, force_overlay =
true) Sup2 = plot(ZZ_ON and showRSLevels ? S2 : na, color = S2 != S2[1]
? na : #ff0000, editable = true, force_overlay = true)

// ===================================================== // ğŸŒ± ZZ MINOR
â€¢ TRUE PIVOT-TO-PIVOT WAVE (FAST) //
=====================================================

// â€” Sensitivity (independent from ZZ Major) zzm_depth = math.max(2,
math.floor(dalam / 3))

// â€” Detect minor pivots [zzm_iH, zzm_pH] = pivots(high, zzm_depth,
true) [zzm_iL, zzm_pL] = pivots(low, zzm_depth, false)

// â€” Pivot memory var int zzm_lastBar = na var float zzm_lastPrice = na

// 1 = last pivot HIGH, 0 = last pivot LOW, -1 = none var int
zzm_lastHigh = -1

// â€” Direction flip flags (used by signals) zzm_turnUp = false
zzm_turnDown = false

// â€” NEW MINOR HIGH PIVOT if not na(zzm_iH) if zzm_lastHigh != 1
zzm_turnDown := true

        if ZZ_ON and showZZMinorWave and not na(zzm_lastBar)
            line.new(
                zzm_lastBar,
                zzm_lastPrice,
                zzm_iH,
                zzm_pH,
                color = color.new(#00FF00, 0),
                width = 1,
                style = line.style_solid,
                force_overlay = true
            )

        zzm_lastBar   := zzm_iH
        zzm_lastPrice := zzm_pH
        zzm_lastHigh  := 1

// â€” NEW MINOR LOW PIVOT if not na(zzm_iL) if zzm_lastHigh != 0
zzm_turnUp := true

        if ZZ_ON and showZZMinorWave and not na(zzm_lastBar)
            line.new(
                zzm_lastBar,
                zzm_lastPrice,
                zzm_iL,
                zzm_pL,
                color = color.new(#00FF00, 0),
                width = 1,
                style = line.style_solid,
                force_overlay = true
            )

        zzm_lastBar   := zzm_iL
        zzm_lastPrice := zzm_pL
        zzm_lastHigh  := 0

// ===================================================== // ğŸŒŠ ZZ MINOR
â€¢ ORIGINAL LEGACY ENGINE (UNTOUCHED) //
=====================================================

zzMinorEntry = ZZ_ON and showAllSignals and showZZMinorSignal and
zzm_turnUp

zzMinorExit = ZZ_ON and showAllSignals and showZZMinorSignal and
zzm_turnDown

zzMinorEntryVisible = showAllSignals and zzMinorEntry and
showZZMinorEntry

zzMinorExitVisible = showAllSignals and zzMinorExit and showZZMinorExit

plotshape( zzMinorEntryVisible, title = â€œZZ Minor Entryâ€, text =
â€œentryâ€, style = shape.labelup, location = location.belowbar, color =
color.new(color.yellow, 0), textcolor = color.rgb(0, 0, 0), size =
size.tiny, force_overlay = true )

plotshape( zzMinorExitVisible, title = â€œZZ Minor Exitâ€, text = â€œexitâ€,
style = shape.labeldown, location = location.abovebar, color =
color.new(color.yellow, 0), textcolor = color.rgb(0, 0, 0), size =
size.tiny, force_overlay = true )

// ===================================================== // ğŸ›ï¸ E2So
ENGINE (MOD â€“ FULL SYSTEM, TOGGLE SAFE) //
===================================================== groupE2So = â€˜ğŸ›ï¸
E2So Settings (MOD)â€™

// â€”- MASTER TOGGLE GATE â€”- E2So_ON = e2soDD_ON

///////////////////////////////////////////////////// // DISPLAY TOGGLES
///////////////////////////////////////////////////// showEntry =
input.bool(true, â€˜E2So Entryâ€™, group = groupE2So) showReEntry =
input.bool(true, â€˜E2So Re-entryâ€™, group = groupE2So) showExit =
input.bool(true, â€˜E2So Exitâ€™, group = groupE2So) showBG =
input.bool(true, â€˜E2So Background Highlightâ€™, group = groupE2So)
showBarColor = input.bool(true, â€˜Color Entry Barâ€™, group = groupE2So)

///////////////////////////////////////////////////// // MIDLINES
DISPLAY SETTINGS /////////////////////////////////////////////////////
showBBMid = input.bool(true, â€˜E2So BB Midlineâ€™, group = groupE2So)
showDCMid = input.bool(true, â€˜E2So Donchian Midlineâ€™, group = groupE2So)
showAvgMid = input.bool(true, â€˜E2So BB + DC Average Lineâ€™, group =
groupE2So)

bbMidColor = input.color(color.fuchsia, â€˜BB Midline Colorâ€™, group =
groupE2So) dcMidColor = input.color(color.orange, â€˜Donchian Midline
Colorâ€™, group = groupE2So) avgMidColor = input.color(color.white,
â€˜Average Line Colorâ€™, group = groupE2So)

midLineWidth = input.int(1, â€˜Midline Widthâ€™, minval = 1, maxval = 5,
group = groupE2So)

///////////////////////////////////////////////////// // BOLLINGER BAND
///////////////////////////////////////////////////// lengthBB =
input.int(20, minval = 1, group = groupE2So) mult = input.float(2.0,
minval = 0.001, maxval = 50, group = groupE2So)

midBB2 = ta.sma(close, lengthBB) devBB2 = mult * ta.stdev(close,
lengthBB) upperBB = midBB2 + devBB2 lowerBB = midBB2 - devBB2

///////////////////////////////////////////////////// // DONCHIAN
CHANNEL MIDLINE /////////////////////////////////////////////////////
dcHighLen = input.int(20, â€˜Donchian High Lengthâ€™, group = groupE2So)
dcLowLen = input.int(20, â€˜Donchian Low Lengthâ€™, group = groupE2So)

dcUpper = ta.highest(high, dcHighLen) dcLower = ta.lowest(low, dcLowLen)
dcMid2 = math.avg(dcUpper, dcLower)

///////////////////////////////////////////////////// // BB + DC AVERAGE
MIDLINE ///////////////////////////////////////////////////// avgMid =
math.avg(midBB2, dcMid2)

///////////////////////////////////////////////////// // MIDLINE PLOTS
(ENGINE-GATED) /////////////////////////////////////////////////////
plot(ZZ_ON and showAllSignals and E2So_ON and showBBMid ? midBB2 : na,
â€˜BB Midâ€™, bbMidColor, math.max(1, midLineWidth), editable = true,
force_overlay = true) plot(ZZ_ON and showAllSignals and E2So_ON and
showDCMid ? dcMid2 : na, â€˜DC Midâ€™, dcMidColor, math.max(1,
midLineWidth), editable = true, force_overlay = true) plot(ZZ_ON and
showAllSignals and E2So_ON and showAvgMid ? avgMid : na, â€˜AVG Midâ€™,
avgMidColor, math.max(1, midLineWidth), editable = true, force_overlay =
true)

///////////////////////////////////////////////////// // STOCH RSI (EXIT
FILTER) ///////////////////////////////////////////////////// smoothK =
input.int(3, group = groupE2So) smoothD = input.int(3, group =
groupE2So) lengthRSI = input.int(14, group = groupE2So) lengthStoch =
input.int(14, group = groupE2So)

rsiBase = ta.rsi(close, lengthRSI) k = ta.sma(ta.stoch(rsiBase, rsiBase,
rsiBase, lengthStoch), smoothK) d = ta.sma(k, smoothD)

exitStoch = ta.crossunder(k, d) and k > 70 and d > 70

///////////////////////////////////////////////////// // CCI
///////////////////////////////////////////////////// lengthCCI =
input.int(20, group = groupE2So) cciMA = ta.sma(close, lengthCCI) cci =
(close - cciMA) / (0.015 * ta.dev(close, lengthCCI)) exitCCI = cci > 200
and exitStoch

///////////////////////////////////////////////////// // MACD CORE
///////////////////////////////////////////////////// fastMA =
ta.ema(close, 12) slowMA = ta.ema(close, 26) macd2 = fastMA - slowMA
signal = ta.ema(macd2, 9) hist2 = macd2 - signal

///////////////////////////////////////////////////// // MOMENTUM & AO
///////////////////////////////////////////////////// mom2 = close -
close[10] ao = ta.sma(hl2, 5) - ta.sma(hl2, 34)

//////////////////////////////////////// ///////////volume MA 20
//////////////// //////////////////////////////////////// volLenE2So =
20 volMA20E2So = ta.sma(volume, volLenE2So)

volWeak = volume < volMA20E2So volMedium = volume >= volMA20E2So and
volume < volMA20E2So * 1.5 volStrong = volume >= volMA20E2So * 1.5

volStrength = volStrong ? â€˜STRONGâ€™ : volMedium ? â€˜MEDIUMâ€™ : â€˜WEAKâ€™

bullishCandle = close > open bearishCandle = close < open

volBias = volStrong and bullishCandle ? â€˜STRONG BULLISHâ€™ : volMedium and
bullishCandle ? â€˜BULLISHâ€™ : volStrong and bearishCandle ? â€˜STRONG
BEARISHâ€™ : volMedium and bearishCandle ? â€˜BEARISHâ€™ : â€˜NEUTRAL / WEAKâ€™ //
===================== // ğŸ“Š VOLUME EMOJI // =====================
volEmoji = volStrong ? â€˜ğŸŸ¢â€™ : volMedium ? â€˜ğŸŸ¡â€™ : â€˜ğŸ”´â€™

// ===================== // ğŸ“Š MOMENTUM SCORE (0â€“100) //
===================== bullScore = 0

bullScore := bullScore + (volStrong ? 40 : volMedium ? 20 : 0) bullScore
:= bullScore + (bullishCandle ? 20 : 0) bullScore := bullScore +
(macd2 > signal ? 20 : 0) bullScore := bullScore + (ta.rsi(close, 14) >
50 ? 20 : 0)

bearScore = 100 - bullScore

momentumScore = bullScore >= 80 ? str.tostring(bullScore) + â€˜/100 ğŸ”¥â€™ :
bullScore >= 60 ? str.tostring(bullScore) + â€˜/100 âœ…â€™ : bullScore >= 40
? str.tostring(bullScore) + â€˜/100 âš ï¸â€™ : str.tostring(bullScore) + â€˜/100
âŒâ€™ // ===================== // ğŸ‚ğŸ» BULL / BEAR LEVEL //
===================== string bullBearLevel = â€˜NEUTRALâ€™

if bullScore >= 80 bullBearLevel := â€˜STRONG BULLâ€™ else if bullScore >=
60 bullBearLevel := â€˜BULLâ€™ else if bullScore <= 20 bullBearLevel :=
â€˜STRONG BEARâ€™ else if bullScore <= 40 bullBearLevel := â€˜BEARâ€™ else
bullBearLevel := â€˜NEUTRALâ€™

// ===================================================== // ğŸ“Š CONTEXT
INDICATORS (ALERT-ONLY, NON-GATING) //
=====================================================

// ===================== // ğŸ“Š PVI (Normalized) // =====================
var float pvi = 100.0

if volume > volume[1] and close[1] != 0 pvi := pvi + ((close - close[1])
/ close[1]) * pvi else pvi := pvi

pviLow = ta.lowest(pvi, 20) pviHigh = ta.highest(pvi, 20) pviNorm =
pviHigh != pviLow ? 100 * (pvi - pviLow) / (pviHigh - pviLow) : 50

pviStatus = pviNorm > 70 ? â€œPVI > 70 (Strong)â€ : pviNorm > 50 ? â€œPVI >
50 (Bullish)â€ : pviNorm < 30 ? â€œPVI < 30 (Weak)â€ : â€œPVI < 50 (Bearish)â€

// ===================== // ğŸ“Š OBV (v6 SAFE) // =====================
obv = ta.cum(volume * math.sign(close - close[1])) obvMA20 = ta.sma(obv,
20)

obvStatus = obv > obvMA20 ? â€œOBV > MA20 (Accumulation)â€ : â€œOBV < MA20
(Distribution)â€

// ===================== // ğŸ“Š OSOB STATE (using bullScore) //
===================== osobStatus = bullScore >= 80 ? â€œOSOB: Overboughtâ€
: bullScore <= 20 ? â€œOSOB: Oversoldâ€ : bullScore > 50 ? â€œOSOB: Above 50â€
: â€œOSOB: Below 50â€

// ===================== // ğŸŸ¦ IBO VOLUME BASE (EARLY DECLARATION) //
===================== volMaLen = 20 volMAIBO = ta.sma(volume, volMaLen)

// ===================================================== // ğŸ§  EZP
ALERTS â€” RAW CONDITIONS (PARSER SAFE v6) //
=====================================================

// â€”â€”â€”- IBO (Intraday Breakout) iboHigh_EZP = ta.highest(high, 1)
iboHighPrev = iboHigh_EZP[1] ezpIBO = high > iboHighPrev //
===================== // ğŸŸ¦ IBO RAW BREAKOUT (EARLY) //
===================== iboRawBreakout = showAllSignals and iboDD_ON and
ezpIBO and volume > volMAIBO

// â€”â€”â€”- VolBO (Volume Breakout) volboHigh_EZP = ta.highest(volume, 20)
volboHighPrev = volboHigh_EZP[1] ezpVolBO = volume > volboHighPrev

// â€”â€”â€”- VolSpike (5m / intraday proxy) volMA20_EZP = ta.sma(volume, 20)
volSpikeLvl = volMA20_EZP * 1.5 ezpVolSpike = volume > volSpikeLvl

// â€”â€”â€”- MACD Breakout macdHigh_EZP = ta.highest(macd2, 20) macdHighPrev
= macdHigh_EZP[1] ezpMACDBO = macd2 > macdHighPrev

// â€”â€”â€”- Trend (Structure / Direction) ema20_EZP = ta.ema(close, 20)
ema50_EZP = ta.ema(close, 50) ezpTrend = close > ema20_EZP and
ema20_EZP > ema50_EZP // ===================== // EMA20 + EMA50 DISTANCE
(%) // =====================

// EMA20 distance (%) // using EXISTING ema20_EZP ema20DistPct = not
na(ema20_EZP) ? (close - ema20_EZP) / ema20_EZP * 100 : na

// Combined distance (%) emaComboDistPct = not na(ema20DistPct) and not
na(ema50DistPct) ? (ema20DistPct + ema50DistPct) / 2 : na //
===================================================== // ğŸ§­ EMA50 ZONE
LABEL // =====================================================
ema50Zone = ema50DistPct > 3 ? â€œEXTENDEDâ€ : ema50DistPct > 0 ? â€œABOVE
EMA50â€ : ema50DistPct > -1 ? â€œNEAR EMA50â€ : â€œBELOW EMA50â€ //
===================== // ğŸ§­ EMA20 ZONE LABEL // =====================
ema20Zone = ema20DistPct > 3 ? â€œEXTENDEDâ€ : ema20DistPct > 0 ? â€œABOVE
EMA20â€ : ema20DistPct > -1 ? â€œNEAR EMA20â€ : â€œBELOW EMA20â€

// ===================== // EMA COMBO ZONE LABEL //
===================== emaComboZone = emaComboDistPct > 4 ? â€œğŸš¨
OVEREXTENDEDâ€ : emaComboDistPct > 2 ? â€œâš ï¸ EXTENDEDâ€ : emaComboDistPct >
0.5 ? â€œâœ… HEALTHY TRENDâ€ : emaComboDistPct > -0.5 ? â€œğŸŸ¡ NEAR EMA ZONEâ€ :
â€œğŸ”´ BELOW EMAâ€ // =====================

// ===================================================== // ğŸ“ˆ IBO
STRUCTURE (EARLY BREAKOUT SAFE) //
===================================================== iboStructureOK =
close > ema20_EZP

// â€”â€”â€”- Strong close (Close Strength) StrongClose = high - (high -
low) * 0.25 ezpStrongClose = close > open and close > StrongClose and
volume > volMA20_EZP

// â€”â€”â€”- ShortSwing (Intraday continuation) macdBull = macd2 > signal
scoreOK = bullScore >= 60

ezpShortSwing = macdBull and scoreOK and ezpVolSpike //
===================================================== // ğŸ“ˆ IBO MOMENTUM
FLIP // =====================================================
iboMomentumBull = macd2 > signal //
===================================================== // ğŸ“ˆ IBO MOMENTUM
EXPANSION // =====================================================
iboMomentumExpand = macd2 > macd2[1]

// Combined momentum condition iboMomentumOK = iboMomentumBull

// ===================================================== // ğŸŒ™ BTST
SESSION WINDOWS (MARKET-AWARE) //
=====================================================

// ğŸ‡²ğŸ‡¾ BURSA (MY time) bursaMorning = not na(time(timeframe.period,
â€œ0900-1200â€, â€œAsia/Kuala_Lumpurâ€)) bursaEvening = not
na(time(timeframe.period, â€œ1600-1700â€, â€œAsia/Kuala_Lumpurâ€))

// ğŸ‡ºğŸ‡¸ US (MY time, mapped from NYSE) // US Open: 22:30 â€“ 02:00 // US
Power Hour (BTST build): 03:30 â€“ 04:00 usMorning = not
na(time(timeframe.period, â€œ2230-2359â€, â€œAsia/Kuala_Lumpurâ€)) or not
na(time(timeframe.period, â€œ0000-0200â€, â€œAsia/Kuala_Lumpurâ€))

usEvening = not na(time(timeframe.period, â€œ0330-0400â€,
â€œAsia/Kuala_Lumpurâ€))

// ğŸ”€ Market-aware routing btstMorning = isBursa ? bursaMorning : isUS ?
usMorning : false btstEvening = isBursa ? bursaEvening : isUS ?
usEvening : false

// ===================================================== // BTST_PRO
(Buy Today Sell Tomorrow â€” Session Structure) //
=====================================================

// â€” Bursa US session flags (Pine v6 SAFE) isMorning = btstMorning
isEvening = btstEvening

// â€” Morning structure memory var float btstMorningHigh = na var float
btstMorningMaxVol = na

// â€” Detect new trading day (FIXED: boolean) bool newDay =
ta.change(time(â€œDâ€)) != 0

// â€” Reset on new day (NO if) btstMorningHigh := newDay ? na :
btstMorningHigh btstMorningMaxVol := newDay ? na : btstMorningMaxVol

// â€” Capture morning reference (NO if) btstMorningHigh := isMorning ?
(na(btstMorningHigh) ? high : math.max(btstMorningHigh, high)) :
btstMorningHigh

btstMorningMaxVol := isMorning ? (na(btstMorningMaxVol) ? volume :
math.max(btstMorningMaxVol, volume)) : btstMorningMaxVol

// â€” BTST conditions (evening only) btstPriceAccept = not
na(btstMorningHigh) and close > btstMorningHigh btstVolDominant = not
na(btstMorningMaxVol) and volume > btstMorningMaxVol btstBuyPressure =
bullScore >= 51

// â€” FINAL BTST_PRO CONDITION ezpBTST_PRO = showAllSignals and (isBursa
or isUS) and isEvening and btstPriceAccept and btstVolDominant and
btstBuyPressure

var float btstEntryPrice = na

if ezpBTST_PRO btstEntryPrice := close

// ===================================================== // ğŸŒ… BTST_PRO
â€” NEXT DAY GAP CONFIRMATION //
=====================================================

// â€” Detect next trading day bool isNextDay = ta.change(time(â€œDâ€)) != 0

// â€” Previous day close (locked) btstPrevClose = ta.valuewhen(isNextDay,
close[1], 0)

// â€” Gap-up condition btstGapUp = open >= btstPrevClose

// â€” Price acceptance (early session hold) btstAccept = close >=
btstPrevClose and low >= btstPrevClose

// â€” Volume confirmation (early strength) btstVolConfirm = volume >=
volMA20E2So

// â€” FINAL GAP CONFIRMATION ezpBTST_GAP_OK = showAllSignals and
ezpBTST_PRO[1] and // yesterday was BTST isNextDay and btstGapUp and
btstAccept and btstVolConfirm

// ===================================================== // BTST_PRO
VISUAL MARKER (4â€“5 PM ONLY) //
===================================================== plotshape( ZZ_ON
and showBTST_PRO and ezpBTST_PRO, title = â€œBTST_PRO Setupâ€, style =
shape.labelup, location = location.belowbar, text = â€œBTSTâ€, size =
size.small, color = color.new(color.purple, 0), textcolor = color.white,
force_overlay = true ) //
===================================================== // BTST_PRO
STRENGTH TIER // =====================================================
string btstTier = â€œNONEâ€

btstTier := ezpBTST_PRO and bullScore >= 75 and volume >=
btstMorningMaxVol * 1.5 and ezpStrongClose ? â€œHIGHâ€ : ezpBTST_PRO and
bullScore >= 65 and volume >= btstMorningMaxVol * 1.2 ? â€œMIDâ€ :
ezpBTST_PRO ? â€œLOWâ€ : â€œNONEâ€

// ===================================================== // ğŸ”¢ EZP SCORE
ENGINE (0â€“100) â€” STEP 2 //
===================================================== ezpScore = 0

ezpScore += ezpIBO ? 15 : 0 ezpScore += ezpVolBO ? 15 : 0 ezpScore +=
ezpVolSpike ? 15 : 0 ezpScore += ezpMACDBO ? 15 : 0 ezpScore += ezpTrend
? 20 : 0 ezpScore += ezpShortSwing ? 20 : 0 ezpScore += ezpStrongClose ?
25 : 0

// Clamp safety ezpScore := ezpScore > 100 ? 100 : ezpScore //
===================================================== // â­ EZP RATING
// ===================================================== ezpRating =
ezpScore >= 85 ? â€œğŸŒŸ EZP SUPERSTOCKâ€ : ezpScore >= 70 ? â€œğŸ”¥ EZP STRONGâ€
: ezpScore >= 55 ? â€œâœ… EZP VALIDâ€ : â€œâš ï¸ EZP WEAKâ€

// ===================================================== // BTST_PRO â†’
EZP SCORE BONUS // =====================================================
btstBonus = btstTier == â€œHIGHâ€ ? 15 : btstTier == â€œMIDâ€ ? 10 : btstTier
== â€œLOWâ€ ? 5 : 0

ezpScore := math.min(100, ezpScore + btstBonus) // =====================
// UTC / DTC CORE // ===================== ema10 = ta.ema(close, 10) //
â€”- UTC / DTC crosses â€”- utcBuy = ta.crossover(ema10, ema50) // UTC
dtcSell = ta.crossunder(ema10, ema50) // DTC

// ===================================================== // ğŸŸ¦ S.UTC
ZONE SCORE (ISOLATED, TABLE-READY) //
=====================================================

// â€” Zone state utcBullZone = ema10 > ema50 utcBearZone = ema10 < ema50

// â€” Zone energy (width) utcZoneWidth = math.abs((ema10 + ao) - (ema50 -
ao))

// â€” Persistent trackers var float utcBullMaxWidth = 0.0 var float
utcBearMaxWidth = 0.0 var int utcBullBars = 0 var int utcBearBars = 0

// â€” Bull tracking if utcBullZone utcBullBars += 1 utcBullMaxWidth :=
math.max(utcBullMaxWidth, utcZoneWidth) else utcBullBars := 0
utcBullMaxWidth := 0

// â€” Bear tracking if utcBearZone utcBearBars += 1 utcBearMaxWidth :=
math.max(utcBearMaxWidth, utcZoneWidth) else utcBearBars := 0
utcBearMaxWidth := 0

// â€” Normalize scores (0â€“100) utcBullWidthScore = math.min(100,
utcBullMaxWidth * 100) utcBearWidthScore = math.min(100,
utcBearMaxWidth * 100)

utcBullDurationScore = math.min(100, utcBullBars * 5)
utcBearDurationScore = math.min(100, utcBearBars * 5)

// â€” Final weighted score utcBullScore = math.round(utcBullWidthScore *
0.6 + utcBullDurationScore * 0.4) utcBearScore =
math.round(utcBearWidthScore * 0.6 + utcBearDurationScore * 0.4)

// ===================== // ğŸ“Œ SCORE SNAPSHOT AT SIGNAL //
===================== var float utcBullScore_atTrigger = na var float
utcBearScore_atTrigger = na utcBullScore_atTrigger := utcBullScore
utcBearScore_atTrigger := utcBearScore // ===================== // ğŸ§ 
UTC / DTC ZONE MOMENTUM (PEAK-AWARE) // =====================

// Smooth width to reduce noise utcWidthEMA = ta.ema(utcZoneWidth, 5)

// Width change (slope) utcWidthDelta = utcWidthEMA - utcWidthEMA[1]

// Threshold to ignore noise widthEps = math.max(utcZoneWidth * 0.02,
0.0001) // ===================== // ğŸ“ˆ ZONE STATE (LOGICAL, NOT
HISTORICAL) // =====================

utcBullState = not utcBullZone ? â€œâ€”â€ : utcWidthDelta > widthEps ? â€œâ–²
Expandingâ€ : utcWidthDelta < -widthEps ? â€œâ–¼ Narrowingâ€ : â€œâ†’ Flatâ€

dtcBearState = not utcBearZone ? â€œâ€”â€ : utcWidthDelta < -widthEps ? â€œâ–²
Narrowingâ€ : // selling pressure expanding utcWidthDelta > widthEps ? â€œâ–¼
Expandingâ€ : // recovery / compression â€œâ†’ Flatâ€

utcBullPctTxt = str.tostring(utcBullScore_atTrigger) + â€œ%â€ dtcBearPctTxt
= str.tostring(utcBearScore_atTrigger) + â€œ%â€

// ===================== // ğŸ§­ LONG-ONLY DTC GATE //
===================== // Allow long entries only when: // 1) Bear zone
is weakening (DTC narrowing), OR // 2) Structure has turned bullish (UTC
bull zone) // ===================== // ğŸ§­ LONG-ONLY DTC GATE
(CORRECTED - STRICT FILTER) // Blocks: // 1) DTC Bear Expanding // 2)
UTC Bull Narrowing // =====================

bool dtcBearExpanding = utcBearZone and utcWidthDelta > widthEps bool
utcBullNarrowing = utcBullZone and utcWidthDelta < -widthEps

dtcLongGate = not dtcBearExpanding and not utcBullNarrowing

// ===================== // ğŸŸ¢ UTC PRE-BULL CONFIRMATION (SAFE) //
=====================

// Structural condition (still below EMA50 but improving)
utcStructurePreBull = ema10 < ema50 and ema10 > ema10[1]

// Zone behavior (bear zone losing power) utcBearWeakening = utcBearZone
and utcBearScore < 60 and utcWidthDelta > 0 // narrowing bear pressure

// Momentum confirmation (existing logic, reused) utcMomentumOK =
ta.crossover(macd2, signal) and hist2 > 0 and mom2 > ao

// â€”- UTC Entry â€”- utcEntry = ta.crossover(macd2, signal) and hist2 > 0
and mom2 > ao and ema10 < ema50 and ema10 > ema10[1] and utcBearZone and
utcBearScore < 60 and utcWidthDelta > 0

// â€”- UTC ReEntry â€”- utcReentry = ta.crossover(macd2, signal) and
macd2 > 0 and hist2 > 0 and mom2 > ao and ta.rsi(close, 14) > 50

///////////////////////////////////////////////////// // ENTRY /
RE-ENTRY / EXIT E2So
///////////////////////////////////////////////////// var bool
e2soInTrade = false

entry = showAllSignals and E2So_ON and dtcLongGate and
ta.crossover(macd2, signal) and macd2 < 0 and hist2 > 0 and cci > -100
and mom2 > ao and volume >= volMA20E2So reentry = showAllSignals and
E2So_ON and dtcLongGate and ta.crossover(macd2, signal) and macd2 > 0
and hist2 > 0 and cci > 50 and mom2 > ao and ta.rsi(close, 14) > 50 and
volume >= volMA20E2So

rawExitSignal = showAllSignals and E2So_ON and (exitCCI or high >=
upperBB and exitStoch) exitSignal = rawExitSignal and e2soInTrade

// ===================== // ğŸ“ˆ E2So TREND VALIDATION //
===================== trendStillValid = E2So_ON and ema20_EZP > ema50
and // trend structure intact macd2 > signal and // momentum still
bullish hist2 > 0 // no bearish momentum flip

// ===================== // ğŸ”„ E2So PULLBACK CONDITION //
===================== pullbackCond = close < avgMid and // price pulled
below mid close > ema50 and // but still above EMA50 hist2 < hist2[1] //
momentum cooling

// ===================== // ğŸ”’ E2So ENTRY LOCK (ALERT SAFE) //
===================== var bool e2soEntryLocked = false var bool
e2soReentryLocked = false

///////////////////////////////////////////////////// // SIGNAL PLOTS
///////////////////////////////////////////////////// plotshape(ZZ_ON
and showE2So and showEntry and entry, â€˜E2So Entryâ€™, shape.labelup,
location.belowbar, color.white, text = â€˜entryâ€™, textcolor =
color.new(#000000, 0), size = size.small, force_overlay = true, editable
= true) plotshape(ZZ_ON and showE2So and showReEntry and reentry, â€˜E2So
ReEntryâ€™, shape.labelup, location.belowbar, color.white, text =
â€˜reentryâ€™, textcolor = color.new(#000000, 0), size = size.small,
force_overlay = true) plotshape(ZZ_ON and showE2So and showExit and
exitSignal, â€˜E2So Exitâ€™, shape.labeldown, location.abovebar,
color.white, text = â€˜exitâ€™, textcolor = color.new(#000000, 0), size =
size.small, force_overlay = true)

// Keep exit logically valid only after an entry/reentry appears first.
if entry or reentry e2soInTrade := true if exitSignal e2soInTrade :=
false

///////////////////////////////////////////////////// // VISUAL EFFECTS
///////////////////////////////////////////////////// bgcolor(ZZ_ON and
showBG and entry ? bgEntryCol : na) bgcolor(ZZ_ON and showBG and reentry
? bgEntryCol : na) bgcolor(ZZ_ON and showBG and exitSignal ? bgExitCol :
na) barcolor(ZZ_ON and showBarColor and entry ? barEntryCol : na)

// ===================== // âš™ï¸ E2Su SETTINGS // =====================
groupE2Su = â€˜ğŸ“ˆ E2Su Controlsâ€™ showExit1 = input.bool(true, â€˜Exit
Signalâ€™, group = groupE2Su)

// ===================================================== // ğŸ‘‘ RBB
ENGINE (TREND AUTHORITY) //
===================================================== lengthRBB =
input.int(20, â€˜RBB Lengthâ€™, group = groupE2Su) multRBB =
input.float(1.0, â€˜RBB Deviation Multâ€™, group = groupE2Su)

midBB_E2Su = ta.sma(close, lengthRBB) devBB_E2Su = multRBB *
ta.stdev(close, lengthRBB) rbbOsc_E2Su = (close - midBB_E2Su) /
devBB_E2Su * 100

// ===================================================== // ğŸ” STATE
MEMORY // ===================================================== var bool
e2suInTrade = false var bool e2suReUsed = false

// Reset when trend dies if rbbOsc_E2Su < -100 e2suInTrade := false
e2suReUsed := false

var bool e2suEntryLocked = false

// ===================================================== // ğŸŸ¢ ENTRY
LOGIC (CONFIRMED BY YOU) //
===================================================== e2suEntry =
showAllSignals and e2suDD_ON and ta.crossover(macd2, signal) and
rbbOsc_E2Su > -100 and not e2suInTrade

// Optional single re-entry e2suReEntry = showAllSignals and e2suDD_ON
and ta.crossover(macd2, signal) and rbbOsc_E2Su > 0 and not e2suInTrade
and not e2suReUsed

if e2suEntry e2suInTrade := true

if e2suReEntry e2suInTrade := true e2suReUsed := true

// ===================================================== // ğŸ”´ EXIT
LOGIC (REFINED & APPROVED) //
===================================================== softExit =
ta.crossunder(macd2, signal) and rbbOsc_E2Su > 0

hardExit = ta.crossunder(rbbOsc_E2Su, -100)

// ğŸ”´ EXIT LOGIC (FIXED ORDER) e2suExit = showAllSignals and e2suDD_ON
and e2suInTrade and (softExit or hardExit)

if e2suExit e2suInTrade := false e2suEntryLocked := false

// ===================================================== // ğŸ–Šï¸ VISUAL
SIGNALS (FORCE OVERLAY) //
===================================================== plotshape( ZZ_ON
and e2suEntry, title = â€˜E2Su Entryâ€™, text = â€˜entryâ€™, style =
shape.labelup, location = location.belowbar, color = color.rgb(5, 86,
47), textcolor = color.white, size = size.small, force_overlay = true )

plotshape( ZZ_ON and e2suExit and showExit1, title = â€˜E2Su Exitâ€™, text =
â€˜exitâ€™, style = shape.labeldown, location = location.abovebar, color =
color.rgb(5, 86, 47), textcolor = color.white, size = size.small,
force_overlay = true )

// ===================================================== // ğŸ§  IBO PRO
REFINEMENT (STRUCTURE + MOMENTUM) //
===================================================== iboProFilter =
iboStructureOK and iboMomentumOK

/// ===================================================== // ğŸ“ˆ IBO
ENGINE : EMA6 / EMA18 (Enhanced) //
=====================================================

// â€” Fixed Parameters emaFastLen = 6 emaSlowLen = 18

// â€” EMA ema6 = ta.ema(close, emaFastLen) ema18 = ta.ema(close,
emaSlowLen) // â€” EMA slope (optional exit filter) ema6SlopeDown = ema6 <
ema6[1] ema6Weak = ema6 <= ema6[1]

// â€” MACD [macdLine, signalLine, _] = ta.macd(close, 12, 26, 9) macdWeak
= macdLine < signalLine or ta.crossunder(macdLine, signalLine)

// ===================================================== // ğŸŸ¦ IBO TRADE
PRECISION LAYER (Buy 1 / Buy 2 style) //
===================================================== iboDcLen =
input.int(13, â€˜IBO Donchian Lengthâ€™, minval = 2)// group = groupEngine)
iboBbLen = input.int(20, â€˜IBO Bollinger Lengthâ€™, minval = 5)// group =
groupEngine) iboBbMult = input.float(1.0, â€˜IBO Bollinger Multiplierâ€™,
minval = 0.1, step = 0.1)// group = groupEngine) iboVolStrongMult =
input.float(1.5, â€˜IBO Strong Volume Multiplierâ€™, minval = 1.0, step =
0.1)// group = groupEngine)

iboDcUpper = ta.highest(high, iboDcLen) iboDrawPoint = close >
iboDcUpper[1]

iboBbBasis = ta.sma(close, iboBbLen) iboBbDev = ta.stdev(close,
iboBbLen) iboBbUpper = iboBbBasis + iboBbDev * iboBbMult

iboVolMA5 = ta.sma(volume, 5) iboVolPass = volume > iboVolMA5
iboVolStrong = volume > iboVolMA5 * iboVolStrongMult and close > open

iboRsvLen = 9 iboSigLen = 3 iboHighest = ta.highest(high, iboRsvLen)
iboLowest = ta.lowest(low, iboRsvLen) iboRange = math.max(iboHighest -
iboLowest, syminfo.mintick) iboRsv = 100 * ((close - iboLowest) /
iboRange) iboK = ta.rma(iboRsv, iboSigLen) iboD = ta.rma(iboK,
iboSigLen) iboJ = 3 * iboK - 2 * iboD

iboEma5 = ta.ema(close, 5) iboEma10 = ta.ema(close, 10) iboEma21 =
ta.ema(close, 21) iboTrendAligned = iboEma5 >= iboEma10 and close >=
iboEma21 iboMomentumAligned = iboJ > iboD

iboBuy1 = iboDrawPoint and iboMomentumAligned and iboTrendAligned and
close >= iboBbUpper and iboVolPass iboBuy2 = iboDrawPoint and
iboMomentumAligned and iboTrendAligned and close >= iboBbUpper and
iboVolStrong

// ===================== // ğŸ”´ SHARED EXIT CORE (E2Su / IBO) //
===================== macdBearishIBO = ta.crossunder(macdLine,
signalLine) lowVolumeIBO = volume < volMAIBO

// â€” Price Change (% from previous close) priceChangePct = (open -
close[1]) / close[1] * 100

// ===================== // ğŸŸ¦ IBO CONFIRMATION // =====================
iboConfirm = ema6 > ema18 and macdLine > signalLine

// ===================== // ğŸŸ¦ FINAL IBO ENTRY (FIXED) //
===================== iboEntry = showAllSignals and iboRawBreakout and
iboStructureOK and iboMomentumOK and iboConfirm and iboBuy1

// â€” Exit Logic // â€” Candle body size (%) bodyPct = math.abs(close -
open) / close[1] * 100

iboExit = showAllSignals and iboDD_ON and macdBearishIBO and
lowVolumeIBO and macdLine > 0

// bearish candle // break EMA6 // bullish regime rollover // strong red
candle // ===================================================== // ğŸ“Š
PLOTS (IBO ENGINE ONLY) EMA6 and EMA18 //
===================================================== plot(ZZ_ON and
showAllSignals and iboDD_ON ? ema6 : na, title = â€˜IBO EMA6â€™, color =
color.yellow, style = plot.style_line, linewidth = 2, force_overlay =
true, editable = true) plot(ZZ_ON and showAllSignals and iboDD_ON ?
ema18 : na, title = â€˜IBO EMA18â€™, color = color.blue, style =
plot.style_line, linewidth = 2, force_overlay = true, editable = true)

// ===================================================== // ğŸ”” ENTRY /
EXIT SIGNALS LABELS //
===================================================== plotshape(ZZ_ON
and iboDD_ON and iboEntry, title = â€˜IBO Entryâ€™, text = â€˜entryâ€™, style =
shape.labelup, location = location.belowbar, color = color.rgb(3, 235,
252), textcolor = color.rgb(0, 0, 0), size = size.tiny, force_overlay =
true, editable = true)

plotshape(ZZ_ON and iboDD_ON and showIBOBuyLevels and iboBuy1, title =
â€˜IBO Buy 1 Precisionâ€™, text = â€˜entryâ€™, style = shape.labelup, location =
location.belowbar, color = color.rgb(3, 235, 252), textcolor =
color.black, size = size.tiny, force_overlay = true, editable = true)

plotshape(ZZ_ON and iboDD_ON and showIBOBuyLevels and iboBuy2, title =
â€˜IBO Buy 2 Precisionâ€™, text = â€˜entryâ€™, style = shape.labelup, location =
location.belowbar, color = color.rgb(3, 235, 252), textcolor =
color.black, size = size.tiny, force_overlay = true, editable = true)

plotshape(ZZ_ON and iboDD_ON and iboExit, title = â€˜IBO Exitâ€™, text =
â€˜exitâ€™, style = shape.labeldown, location = location.abovebar, color =
color.rgb(3, 235, 252), textcolor = color.rgb(0, 0, 0), size =
size.tiny, force_overlay = true, editable = true)

plot(ZZ_ON and showAllSignals and useEMA50 and (e2suDD_ON or iboDD_ON) ?
ema50 : na,title = â€˜EMA 50â€™,color = color.white,linewidth =
2,force_overlay = true)

// ====================================================== // ğŸŒŠ EWsub
ENTRY / EXIT LOGIC //
====================================================== ewEntry =
showAllSignals and ewSignal_ON and showEWEntry and trend == 1 and not
na(zigzag)

ewExit = showAllSignals and ewSignal_ON and showEWExit and trend == -1
and not na(zigzag)

// ===================================================== // ğŸŒŠ EW
SUBWAVE LINE // =====================================================
plot( ZZ_ON and ewLine_ON ? zigzag : na, title = â€˜EW Subwaveâ€™, color =
color.new(color.yellow, 0), linewidth = 1, offset = -1, force_overlay =
true )

// ===================================================== // ğŸŒŠ EW ENTRY
/ EXIT LABELS // =====================================================
if ZZ_ON and ewEntry label.new(bar_index, zigzag, â€˜entryâ€™, style =
label.style_label_up, size = size.small, textcolor = color.rgb(0, 0, 0),
color = color.new(color.lime, 0), force_overlay = true)

if ZZ_ON and ewExit label.new(bar_index, zigzag, â€˜exitâ€™, style =
label.style_label_down, size = size.small, textcolor = color.rgb(0, 0,
0), color = color.new(color.lime, 0), force_overlay = true)

// ================================================== // ğŸ”Œ SLAVE :
BURSA / US / FCPO (SESSION MARKERS) //
================================================== groupSessionSlave =
â€˜ğŸ”Œ Session Markers (Bursa / US / FCPO)â€™

// FINAL GATE (MASTER âœ SLAVE) SESSION_ON = ZZ_MASTER_ON and
SESSION_SLAVE_ON

// ================================================== // ğŸ“ AUTO SESSION
LABEL (ALERT USE ONLY) //
==================================================

string sessionLabel = â€˜Outside Sessionâ€™ tz = â€˜Asia/Kuala_Lumpurâ€™ // ğŸ‡²ğŸ‡¾
BURSA if market == â€˜Bursaâ€™ if hour(time, tz) >= 9 and hour(time, tz) <
12 sessionLabel := â€˜BURSA Morningâ€™ sessionLabel else if hour(time,
tz) >= 14 and hour(time, tz) < 17 sessionLabel := â€˜BURSA Afternoonâ€™
sessionLabel else sessionLabel := â€˜BURSA Outsideâ€™ sessionLabel

// ğŸ‡ºğŸ‡¸ US (MY Time) if market == â€˜USâ€™ if hour(time, tz) >= 22 or
hour(time, tz) < 2 sessionLabel := â€˜US Openâ€™ sessionLabel else if
hour(time, tz) >= 2 and hour(time, tz) < 5 sessionLabel := â€˜US Reopenâ€™
sessionLabel else sessionLabel := â€˜US Outsideâ€™ sessionLabel

// ğŸŒ´ FCPO if market == â€˜FCPOâ€™ if hour(time, tz) >= 10 and hour(time,
tz) < 12 sessionLabel := â€˜FCPO Morningâ€™ sessionLabel else if hour(time,
tz) >= 14 and hour(time, tz) < 18 sessionLabel := â€˜FCPO Afternoonâ€™
sessionLabel else if hour(time, tz) >= 21 sessionLabel := â€˜FCPO Nightâ€™
sessionLabel else sessionLabel := â€˜FCPO Outsideâ€™ sessionLabel

// ================================================== // âš™ï¸ COMMON
SETTINGS // ==================================================
daysToShow = input.int(3, â€˜Show Last N Daysâ€™, group = groupSessionSlave)
lw = input.int(1, â€˜Line Widthâ€™, minval = 1, group = groupSessionSlave)
lb = input.int(200, â€˜Lookbackâ€™, minval = 50, group = groupSessionSlave)

// ===================================================== // ğŸ·ï¸ EZP TAG
COMPOSER // =====================================================
ezpTags = â€œâ€

ezpTags += ezpIBO ? â€œ#IBOâ€ : â€œâ€ ezpTags += ezpVolBO ? â€œ#VolBOâ€ : â€œâ€
ezpTags += ezpVolSpike ? â€œ#VolSpikeâ€ : â€œâ€ ezpTags += ezpMACDBO ?
â€œ#MACDBOâ€ : â€œâ€ ezpTags += ezpTrend ? â€œ#Trendâ€ : â€œâ€ ezpTags +=
ezpStrongClose ? â€œ#StrongCloseâ€: â€œâ€ ezpTags += ezpShortSwing ?
â€œ#ShortSwingâ€ : â€œâ€ ezpTags += iboProFilter ? â€œ#IBO_PROâ€ : â€œâ€ // â€”
BTST_PRO TAGS ezpTags += ezpBTST_PRO ? â€œ#BTSTâ€ : â€œâ€

ezpTags += ezpBTST_PRO and isBursa ? â€œ#BTST_BURSAâ€ : â€œâ€ ezpTags +=
ezpBTST_PRO and isUS ? â€œ#BTST_USâ€ : â€œâ€

ezpTags += ezpBTST_PRO and btstTier == â€œHIGHâ€ ? â€œ#BTST_HIGHâ€ :
ezpBTST_PRO and btstTier == â€œMIDâ€ ? â€œ#BTST_MIDâ€ : ezpBTST_PRO and
btstTier == â€œLOWâ€ ? â€œ#BTST_LOWâ€ : â€œâ€

// ================================================== // ğŸ“† DAY FILTER
// ================================================== dayFlip =
ta.change(time(â€œDâ€)) != 0

var int dayCount = 0 if dayFlip dayCount := dayCount + 1 dayCount

totalDays = ta.highest(dayCount, 1000) showDay = totalDays - dayCount <
daysToShow

rTop = isFCPO ? ta.highest(high, lb * 2) : ta.highest(high, lb) rBot =
isFCPO ? ta.lowest(low, lb * 2) : ta.lowest(low, lb)

// ================================================== // ğŸ‡²ğŸ‡¾ BURSA //
================================================== groupBursa = â€˜ğŸ‡²ğŸ‡¾
Bursa Settingsâ€™

vmB = input.float(2.0, â€˜Volume Multiplierâ€™, group = groupBursa) minVB =
input.int(30000, â€˜Minimum Volumeâ€™, group = groupBursa)

bursaMorningCol = input.color(color.green, â€˜Morning Lineâ€™, group =
groupBursa) bursaAfternoonCol = input.color(color.orange, â€˜Afternoon
Lineâ€™, group = groupBursa)

showBursaLabels = input.bool(true, â€˜Show Session Labelsâ€™, group =
groupBursa)

morn_start = timestamp(tz, year, month, dayofmonth, 9, 30) aft_start =
timestamp(tz, year, month, dayofmonth, 14, 30)

avgVB = ta.sma(volume, 20) volSpikeB = volume > avgVB * vmB and
volume >= minVB

plotshape(SESSION_ON and isBursa and showDay and time == morn_start and
volSpikeB, title = â€˜Bursa Morning Spikeâ€™, style = shape.arrowup,
location = location.belowbar, size = size.tiny, color = sessTextCol,
force_overlay = true)

if SESSION_ON and isBursa and showDay and bool(newDay)
line.new(bar_index, rBot, bar_index, rTop, extend = extend.both, color =
bursaMorningCol, width = lw)

if SESSION_ON and isBursa and showDay and hour(time, tz) == 14 and
minute(time, tz) == 30 line.new(bar_index, rBot, bar_index, rTop, extend
= extend.both, color = bursaAfternoonCol, width = lw)

// ================================================== // ğŸ‡ºğŸ‡¸ US MARKET //
================================================== groupUS = â€˜ğŸ‡ºğŸ‡¸ US
Settingsâ€™

usOpenCol = input.color(color.green, â€˜Open Lineâ€™, group = groupUS)
usReopenCol = input.color(color.orange, â€˜Reopen Lineâ€™, group = groupUS)

hUS = hour(time, tz) miUS = minute(time, tz)

if SESSION_ON and isUS and showDay and hUS == 22 and miUS == 30
line.new(bar_index, rBot, bar_index, rTop, extend = extend.both, color =
usOpenCol, width = lw)

if SESSION_ON and isUS and showDay and hUS == 2 and miUS == 0
line.new(bar_index, rBot, bar_index, rTop, extend = extend.both, color =
usReopenCol, width = lw)

// ================================================== // ğŸŒ´ FCPO //
================================================== groupFCPO = â€˜ğŸŒ´ FCPO
Settingsâ€™

fcpoOpenCol = input.color(color.green, â€˜10:30 Lineâ€™, group = groupFCPO)
fcpoReopenCol = input.color(color.orange, â€˜14:30 Lineâ€™, group =
groupFCPO) fcpoNightCol = input.color(color.rgb(170, 0, 255), â€˜21:00
Lineâ€™, group = groupFCPO) fcpoNightTextCol = color.white
fcpoNightLabelText = â€œnight.openâ€ nightLabelY = rTop + (rTop - rBot) *
0.02

open1030 = timestamp(tz, year, month, dayofmonth, 10, 30) reopen1430 =
timestamp(tz, year, month, dayofmonth, 14, 30) night2100 = timestamp(tz,
year, month, dayofmonth, 21, 0)

if SESSION_ON and isFCPO and showDay and time >= open1030 and time[1] <
open1030 line.new(bar_index, rBot, bar_index, rTop, extend =
extend.both, color = fcpoOpenCol, width = lw)

if SESSION_ON and isFCPO and showDay and time >= reopen1430 and time[1]
< reopen1430 line.new(bar_index, rBot, bar_index, rTop, extend =
extend.both, color = fcpoReopenCol, width = lw)

if SESSION_ON and isFCPO and showDay and time >= night2100 and time[1] <
night2100 line.new(bar_index, rBot, bar_index, rTop, extend =
extend.both, color = fcpoNightCol, width = lw)

if SESSION_ON and isBursa and showDay and bool(newDay) and
showBursaLabels label.new(bar_index, rTop, â€˜openâ€™, style =
label.style_label_down, textcolor = sessLblText, color =
bursaMorningCol, size = size.small, yloc = yloc.price, force_overlay =
true)

if SESSION_ON and isBursa and showDay and hour(time, tz) == 14 and
minute(time, tz) == 30 and showBursaLabels label.new(bar_index, rTop,
â€˜reopenâ€™, style = label.style_label_down, textcolor = sessLblText, color
= bursaAfternoonCol, size = size.small, yloc = yloc.price, force_overlay
= true)

if SESSION_ON and isUS and showDay and hUS == 22 and miUS == 30
label.new(bar_index, rTop, â€˜openâ€™, style = label.style_label_down,
textcolor = sessLblText, color = usOpenCol, size = size.small, yloc =
yloc.price, force_overlay = true)

if SESSION_ON and isUS and showDay and hUS == 2 and miUS == 0
label.new(bar_index, rTop, â€˜reopenâ€™, style = label.style_label_down,
textcolor = sessLblText, color = usReopenCol, size = size.small, yloc =
yloc.price, force_overlay = true)

if SESSION_ON and isFCPO and showDay and time >= open1030 and time[1] <
open1030 label.new(bar_index, rTop, â€˜openâ€™, style =
label.style_label_down, textcolor = sessLblText, color = fcpoOpenCol,
size = size.small, yloc = yloc.price, force_overlay = true)

if SESSION_ON and isFCPO and showDay and time >= reopen1430 and time[1]
< reopen1430 label.new(bar_index, rTop, â€˜reopenâ€™, style =
label.style_label_down, textcolor = sessLblText, color = fcpoReopenCol,
size = size.small, yloc = yloc.price, force_overlay = true)

if SESSION_ON and isFCPO and showDay and time >= night2100 and time[1] <
night2100 label.new(bar_index, nightLabelY, â€˜night.openâ€™, style =
label.style_label_down, textcolor = fcpoNightTextCol, color =
fcpoNightCol, size = size.small, yloc = yloc.price, force_overlay =
true)

// ================================================== // ğŸ“Š VWAP //
================================================== groupVWAP = â€˜ğŸ“Š VWAP
(Session)â€™

useVWAP_FCPO = input.bool(true, â€˜FCPO VWAPâ€™, group = groupVWAP)
useVWAP_Bursa = input.bool(true, â€˜Bursa VWAPâ€™, group = groupVWAP)
useVWAP_US = input.bool(true, â€˜US VWAPâ€™, group = groupVWAP) //
================= VWAP COLORS ================= fcpoVWAPCol =
input.color(color.yellow, â€˜FCPO VWAP Colorâ€™, group = groupVWAP)
bursaVWAPCol = input.color(color.aqua, â€˜Bursa VWAP Colorâ€™, group =
groupVWAP) usVWAPCol = input.color(color.fuchsia, â€˜US VWAP Colorâ€™, group
= groupVWAP)

vwapAll = ta.vwap(hlc3)

plot(SESSION_ON and isFCPO and useVWAP_FCPO ? vwapAll : na, â€˜FCPO VWAPâ€™,
fcpoVWAPCol, 1, force_overlay = true)

plot(SESSION_ON and isBursa and useVWAP_Bursa ? vwapAll : na, â€˜Bursa
VWAPâ€™, bursaVWAPCol, 1, force_overlay = true)

plot(SESSION_ON and isUS and useVWAP_US ? vwapAll : na, â€˜US VWAPâ€™,
usVWAPCol, 1, force_overlay = true)

// ===================== // ğŸ¦ EXCHANGE (SAFE) // =====================
var string exchangeName = â€œUNKNOWNâ€

if barstate.isfirst parts = str.split(syminfo.tickerid, â€œ:â€)
exchangeName := array.size(parts) > 0 ? array.get(parts, 0) : â€œUNKNOWNâ€

// â° ALERT TIME (SAFE, FINAL) string alertTime = str.format_time(time,
â€œyyyy-MM-dd HH:mmâ€, syminfo.timezone)

// ===================================================== // ğŸ“… FCPO
EXPIRY DATE & COUNTDOWN //
=====================================================

// FCPO expiry assumed on 15th of contract month (Bursa standard)
fcpoExpiryTS = isFCPO and not na(fcpoMonth) and not na(fcpoYear) ?
timestamp(â€œAsia/Kuala_Lumpurâ€, fcpoYear, fcpoMonth, 15, 17, 0) : na

daysToExpiry = not na(fcpoExpiryTS) ? math.floor((fcpoExpiryTS - time) /
86400000) : na

// ğŸ­ SECTOR (SAFE)

// ===================== // ğŸ¯ RISK / REWARD SETTINGS (ALERT ONLY) //
===================== riskATRLen = 14 riskATRMult = 1.5 // Stop loss =
1.5 ATR tp1RR = 1.0 // 1R tp2RR = 2.0 // 2R tp3RR = 3.0 // 3R

atrValue = ta.atr(riskATRLen) // ===================== // ATR-NORMALIZED
EMA DISTANCE (ALERT CONTEXT) // =====================

// EMA20 ATR distance ema20ATRDist = not na(ema20_EZP) and atrValue > 0
? (close - ema20_EZP) / atrValue : na

// EMA50 ATR distance ema50ATRDist = not na(ema50) and atrValue > 0 ?
(close - ema50) / atrValue : na

// Combined ATR distance emaATRCombo = not na(ema20ATRDist) and not
na(ema50ATRDist) ? (ema20ATRDist + ema50ATRDist) / 2 : na //
=====================
// ATR EMA ZONE LABEL // ===================== emaATRZone =
emaATRCombo > 2.5 ? â€œğŸš¨ ATR OVEREXTENDEDâ€ : emaATRCombo > 1.5 ? â€œâš ï¸ ATR
EXTENDEDâ€ : emaATRCombo > 0.5 ? â€œâœ… ATR HEALTHYâ€ : emaATRCombo >= 0 ?
â€œğŸŸ¡ ATR NEAR EMAâ€ : â€œğŸ”´ ATR BELOW EMAâ€ // ===================== // ğŸ“Œ
ENTRY PRICE & TARGETS (ALERT ONLY) // ===================== entryPrice =
close

stopLoss = entryPrice - atrValue * riskATRMult riskPerUnit =
entryPrice - stopLoss

tp1 = entryPrice + riskPerUnit * tp1RR tp2 = entryPrice + riskPerUnit *
tp2RR tp3 = entryPrice + riskPerUnit * tp3RR

// ===================================================== // ğŸš¨ FCPO
EXPIRY WARNING FLAGS //
===================================================== fcpoExpiry7d =
isFCPO and daysToExpiry <= 7 and daysToExpiry > 3 fcpoExpiry3d = isFCPO
and daysToExpiry <= 3 and daysToExpiry > 1 fcpoExpiry1d = isFCPO and
daysToExpiry <= 1 and daysToExpiry >= 0

// ===================== // ğŸ§  ANALYST DATA (SAFE FOR ALERTS) //
===================== f_num(x) => na(x) ? â€œN/Aâ€ : str.tostring(x)

f_price(x) => na(x) ? â€œN/Aâ€ : str.tostring(x, format.mintick)

f_date(x) => na(x) ? â€œN/Aâ€ : str.format_time(x, â€œyyyy-MM-ddâ€)

f_atr(x) => na(x) ? â€œN/Aâ€ : str.tostring(x, â€œ#.##â€) + â€ ATRâ€

emaATRChaseWarning = emaATRCombo > 2.5

recBuy = f_num(syminfo.recommendations_buy) recBuyStrong =
f_num(syminfo.recommendations_buy_strong) recHold =
f_num(syminfo.recommendations_hold) recSell =
f_num(syminfo.recommendations_sell) recSellStrong =
f_num(syminfo.recommendations_sell_strong) recTotal =
f_num(syminfo.recommendations_total)

tpHigh = f_price(syminfo.target_price_high) tpLow =
f_price(syminfo.target_price_low) tpCount =
f_num(syminfo.target_price_estimates) tpDate =
f_date(syminfo.target_price_date)

// ===================== // ğŸ“Š ANALYST CONSENSUS SCORE (0â€“100) â€” SAFE //
=====================

// Raw analyst counts (TradingView built-in) buyStrong =
syminfo.recommendations_buy_strong buyNormal =
syminfo.recommendations_buy holdCount = syminfo.recommendations_hold
sellNormal = syminfo.recommendations_sell sellStrong =
syminfo.recommendations_sell_strong totalRecs =
syminfo.recommendations_total

// Weighted score calculation rawScore = buyStrong * 2 + buyNormal * 1 +
holdCount * 0 + sellNormal * -1 + sellStrong * -2

// Normalize to 0â€“100 consensusScore = totalRecs > 0 ? math.round(50 +
(rawScore / (totalRecs * 2)) * 50) : na

// Clamp safety (never below 0 or above 100) consensusScore :=
consensusScore > 100 ? 100 : consensusScore < 0 ? 0 : consensusScore

// Text label for alerts consensusLabel = consensusScore >= 80 ? â€œğŸ”¥
STRONG BULLISHâ€ : consensusScore >= 60 ? â€œâœ… BULLISHâ€ :
consensusScore >= 45 ? â€œâš ï¸ NEUTRALâ€ : consensusScore >= 25 ? â€œâŒ
BEARISHâ€ : â€œğŸ§¨ STRONG BEARISHâ€ // ===================== // ğŸ“Š ANALYST
CONSENSUS DISPLAY (TABLE) // ===================== string
analystBreakdown = â€œB:â€ + str.tostring(buyNormal) + â€ SB:â€ +
str.tostring(buyStrong) + â€ H:â€ + str.tostring(holdCount)

string analystBreakdownCompact = â€œB:â€ + str.tostring(buyNormal) +
â€œ|SB:â€ + str.tostring(buyStrong) + â€œ|H:â€ + str.tostring(holdCount)

// ===================================================== // ğŸ”” FAST
ALERT HELPER (MID-BAR, NO SPAM) //
=====================================================
f_fireAlert(_condition, _message, _lastBarRef) => var int _ret =
_lastBarRef bool canFire = na(_lastBarRef) or bar_index != _lastBarRef
if barstate.isrealtime and _condition and canFire alert(_message,
alert.freq_once_per_bar) _ret := bar_index _ret

// ===================================================== // ğŸ”” CONFIRMED
ALERT HELPER (DAILY / NON-TRADING) //
=====================================================
f_fireConfirmedAlert(_condition, _message, _fired) => if _condition and
not _fired alert(_message, alert.freq_once_per_bar) true else _fired

//////////////////////////////////////////////////////// //
===================================================== // INPUTS ZZ.CORE
Entry Exit Signal nd plot //
=====================================================
//////////////////////////////////////////////////////// useLong =
input.bool(true, â€œEnable Longâ€) reEntryCooldown = input.int(3, â€œRe-entry
cooldown (bars)â€, minval=1)

// ===================================================== // MARKET STATE
(SIMPLIFIED ZZ MAJOR) //
===================================================== majorLen =
input.int(55, â€œMajor Structure Lengthâ€)

hh = ta.highest(high, majorLen) ll = ta.lowest(low, majorLen)

marketUp = close > ll and hh > hh[1] marketDown = close < hh and ll <
ll[1]

// ===================================================== // STRUCTURE
(ZZ MINOR) // =====================================================
minorLen = input.int(21, â€œMinor Structure Lengthâ€)

structUp = close > ta.lowest(low, minorLen) structDown = close <
ta.highest(high, minorLen)

// ===================================================== // MOMENTUM
(RSI PLACEHOLDER â€“ SAME AS STRATEGY) //
===================================================== e2su =
ta.rsi(close, 14) > 55 e2so = ta.rsi(close, 14) < 45

// ===================================================== // ENTRY
TRIGGER (SUBWAVE / BREAKOUT) //
===================================================== subwaveHL = low >
low[1] and low[1] < low[2] subwaveLH = high < high[1] and high[1] >
high[2]

breakHigh = close > ta.highest(high, 10)[1] breakLow = close <
ta.lowest(low, 10)[1]

// ===================================================== // LABEL
CONDITIONS (SAME AS STRATEGY) //
=====================================================

// GREEN LABEL â†’ ENTRY / RE-ENTRY buyLabel = useLong and marketDown and
structDown and e2so and not e2su and (subwaveLH or breakLow)

// RED LABEL â†’ EXIT sellLabel = useLong and marketUp and structUp and
e2su and not e2so and (subwaveHL or breakHigh)

// ğŸŸ¡ RE-ENTRY ZONE (trend continuation) reEntryLabel = useLong and
marketUp and structUp and not e2so and e2su and (subwaveHL or breakHigh)
// ===================================================== // STATE ENGINE
(SIMULATED POSITION) //
===================================================== var bool inTrade =
false var int lastExitBar = na var bool reEntryUsed = false var bool
hadEntry = false var bool highPriorityAlertFired = false

canReEnter = not inTrade and (na(lastExitBar) or bar_index >
lastExitBar + reEntryCooldown)

// ===================================================== // SIGNAL LOGIC
// =====================================================
entrySignalZZCore = dtcLongGate and buyLabel and not inTrade

if entrySignalZZCore inTrade := true reEntryUsed := false hadEntry :=
true

reEntrySignalZZCore = dtcLongGate and reEntryLabel and canReEnter and
not reEntryUsed and hadEntry

exitSignalZZCore = sellLabel and inTrade

// ===================================================== // STATE UPDATE
// ===================================================== if
reEntrySignalZZCore inTrade := true reEntryUsed := true

if exitSignalZZCore inTrade := false lastExitBar := bar_index
reEntryUsed := false

// ===================================================== // ğŸ‘ï¸ ZZ CORE â€”
VISIBILITY GATES (UI ONLY) //
===================================================== zzCoreEntryVisible
= showAllSignals and entrySignalZZCore and showZZCoreSignal and
showZZCoreEntry

zzCoreReEntryVisible = showAllSignals and reEntrySignalZZCore and
showZZCoreSignal and showZZCoreReEntry

zzCoreExitVisible = showAllSignals and exitSignalZZCore and
showZZCoreSignal and showZZCoreExit

// ===================================================== // PLOTS //
===================================================== plotshape( ZZ_ON
and zzCoreEntryVisible, title=â€œZZ CORE ENTRYâ€, text=â€œentryâ€,
style=shape.labelup, location=location.belowbar, color=color.rgb(249, 0,
121), textcolor=color.white, size=size.tiny, force_overlay=true )

plotshape( ZZ_ON and zzCoreReEntryVisible, title=â€œZZ CORE REENTRYâ€,
text=â€œreentryâ€, style=shape.labelup, location=location.belowbar,
color=color.rgb(249, 0, 121), textcolor=color.white, size=size.tiny,
force_overlay=true )

plotshape( ZZ_ON and zzCoreExitVisible, title=â€œZZ CORE EXITâ€,
text=â€œexitâ€, style=shape.labeldown, location=location.abovebar,
color=color.rgb(249, 0, 121), textcolor=color.white, size=size.tiny,
force_overlay=true )

////////////////////////////////////////////////////////////////
/////////////////SYARIAH LABEL//////////////////////////////////
///////////////////////////////////////////////////////////////
isNonSyariah = array.includes(BURSA_NON_SYARIAH, syminfo.ticker)
isUSHalal = array.includes(US_SHARIAH_MASTER, syminfo.ticker)
isUSDoubtful = array.includes(US_DOUBTFUL, syminfo.ticker) isUSNotHalal
= array.includes(US_NOT_HALAL, syminfo.ticker) isCryptoHalal =
array.includes(CRYPTO_HALAL, syminfo.ticker) isPN17 =
array.includes(PN17_LIST, syminfo.ticker) isGN3 =
array.includes(GN3_LIST, syminfo.ticker)

// Market-aware Syariah isSyariah = isBursa ? not isNonSyariah : false
string shariahLabel = isBursa ? (isSyariah ? â€œâ˜ªï¸ Syariah (SAC MY)â€ : â€œâ˜ªï¸
Non-Syariah (SAC MY)â€) : isUS ? (isUSHalal ? â€œâ˜ªï¸ Shariah Screened (US)â€
: isUSDoubtful ? â€œâš ï¸ Shariah: Doubtful (US)â€ : isUSNotHalal ? â€œâŒ
Non-Shariah (US)â€ : â€œâšª Shariah: Not Screenedâ€) : isCrypto ?
(isCryptoHalal ? â€œğŸª™ Shariah-Permissible (Use-Based)â€ : â€œâš ï¸ Shariah:
Review Requiredâ€) : â€œâšª Shariah: N/Aâ€ ////////////////////////// string
distressLabel = â€œâ€

if isPN17 distressLabel := â€œğŸš¨ PN17: Financially Distressed (Main
Market)â€ else if isGN3 distressLabel := â€œâš ï¸ GN3: Distressed (ACE
Market)â€

// ===================================================== // ğŸ·ï¸
MARKET-AWARE STATUS LABEL (FINAL) //
=====================================================

string complianceLabel = â€œâ€

if isBursa complianceLabel := isPN17 ? â€œğŸš¨ PN17: Financially Distressed
(MAIN)â€ : isGN3 ? â€œâš ï¸ GN3: Financially Distressed (ACE)â€ : shariahLabel

else if isUS complianceLabel := shariahLabel + â€œğŸ“œ Regulation: SEC /
NASDAQâ€

else if isCrypto complianceLabel := shariahLabel + â€œğŸ“œ Regulation:
Use-Based Screeningâ€

else if isFCPO complianceLabel := â€œğŸ“œ Regulated Derivative: Bursa FCPOâ€

else complianceLabel := â€œğŸ“œ Regulation: N/Aâ€

// ===================== // ğŸ§  SMART EMA STACK LABEL //
===================== string emaStackShort = â€œEMA:OFFâ€

if useEMA50 if ema20_EZP > ema50 emaStackShort := â€œEMA20>EMA50â€ else
emaStackShort := â€œEMA20<EMA50â€

///========================= ///===chart link ======
////===================

// ===================== // âœ… FINAL SAFE ALERT SYMBOL (NO JSON EVER) //
===================== string alertSymbol = isFCPO ? syminfo.prefix +
â€œ:â€ + syminfo.ticker : syminfo.tickerid

// ===================== // ğŸ·ï¸ ALERT HEADER (DISPLAY ONLY) //
===================== string alertHeader = isFCPO ? alertSymbol + â€ |
FCPO (Current Contract)â€ : alertSymbol

// ===================== // ğŸ”— SAFE TRADINGVIEW CHART LINK //
===================== string chartLink =
â€œhttps://www.tradingview.com/chart/?symbol=â€ +
str.replace_all(alertSymbol, â€œ:â€, â€œ%3Aâ€)

// ===================================================== // â° CRYPTO
DAILY FAILSAFE RESET //
===================================================== if isCrypto and
ta.change(time(â€œDâ€)) != 0 e2soEntryLocked := false e2soReentryLocked :=
false e2soInTrade := false e2suEntryLocked := false zzMajorV2InTrade :=
false zzMajorV2Armed := false

// ===================================================== // ğŸš¨ ALERT
LOCKS â€” ONE PER ENGINE // ğŸ”’ LOCK / STATE VARIABLES //
===================================================== var bool
alert_E2Su = false

var bool alert_E2So_Entry = false var bool alert_E2So_Re = false var
bool alert_E2So_Exit = false var bool alert_ZZCore = false var bool
alert_ZZMajorV2 = false var bool alert_ZZMinor = false var bool
alert_UTC_Cross = false var bool alert_UTC_Entry = false var bool
alert_UTC_Reentry = false var bool alert_BTST = false var bool alert_IBO
= false var bool alert_FCPO = false

// ===================================================== // â›” BAR-INDEX
GUARDS (FAST ALERT MODE) //
=====================================================

// E2 engines var int lastBar_E2Su = na var int lastBar_E2SoEntry = na
var int lastBar_E2SoReentry = na var int lastBar_E2SoExit = na

// ZZ engines var int lastBar_ZZCore = na var int lastBar_ZZMajor = na
var int lastBar_ZZMinor = na

// Other systems var int lastBar_UTC = na var int lastBar_IBO = na var
int lastBar_BTST = na

// ===================================================== // ğŸ”„ ALERT
RESET â€” ONCE PER BAR //
===================================================== if barstate.isnew
highPriorityAlertFired := false alert_E2Su := false alert_E2So_Entry :=
false alert_E2So_Re := false alert_E2So_Exit := false alert_ZZCore :=
false alert_ZZMajorV2 := false alert_ZZMinor := false alert_UTC_Cross :=
false alert_UTC_Entry := false alert_UTC_Reentry := false alert_BTST :=
false alert_IBO := false alert_FCPO := false

// UTC ENTRY COOLDOWN RESET if barstate.isconfirmed and not utcBearZone
alert_UTC_Entry := false alert_UTC_Reentry := false

if not e2soEntryLocked e2soReentryLocked := false

if emaStackShort == â€œBearâ€ e2soReentryLocked := false //
===================== // ğŸ”’ E2So REENTRY STATE // =====================
e2soReentryState = ZZ_ON and e2soEntryLocked and not e2soReentryLocked
and not exitSignal and not na(lastBar_E2SoEntry) and bar_index >
lastBar_E2SoEntry and pullbackCond and trendStillValid

// ğŸ”“ E2So REENTRY AUTO-RESET (TREND SAFE) if barstate.isrealtime and
(macd2 < signal or hist2 < 0) e2soReentryLocked := false // Auto-unlock
if trend weakens

if not trendStillValid e2soReentryLocked := false

// ===================================================== // ğŸ‚ Major
Bull Score (All-time Major Candle) //
=====================================================

// â€” Detect earliest bar var float mb_firstOpen = na if na(mb_firstOpen)
mb_firstOpen := open

// â€” All-time High / Low var float mb_allTimeHigh = na var float
mb_allTimeLow = na

mb_allTimeHigh := na(mb_allTimeHigh) ? high : math.max(mb_allTimeHigh,
high) mb_allTimeLow := na(mb_allTimeLow) ? low : math.min(mb_allTimeLow,
low)

// â€” Current Close float mb_C = close float mb_O = mb_firstOpen float
mb_H = mb_allTimeHigh float mb_L = mb_allTimeLow

// â€” Range float mb_rng = math.max(mb_H - mb_L, syminfo.mintick)

// â€” Ratios float mb_bodyStrength = (mb_C - mb_O) / mb_rng float
mb_upperRatio = (mb_H - mb_C) / mb_rng float mb_lowerRatio = (mb_O -
mb_L) / mb_rng

// â€” Score Logic string mb_majorScore = â€œEâ€ float mb_majorPct =
mb_bodyStrength * 100.0

if mb_C <= mb_O mb_majorScore := â€œFâ€ else if mb_bodyStrength >= 0.90 and
mb_upperRatio <= 0.05 and mb_lowerRatio <= 0.05 mb_majorScore := â€œA+â€
else if mb_bodyStrength >= 0.80 and mb_upperRatio <= 0.10 and
mb_lowerRatio <= 0.10 mb_majorScore := â€œAâ€ else if mb_bodyStrength >=
0.70 mb_majorScore := â€œBâ€ else if mb_bodyStrength >= 0.60 mb_majorScore
:= â€œCâ€ else if mb_bodyStrength >= 0.50 mb_majorScore := â€œDâ€ else
mb_majorScore := â€œEâ€

// â€” ready line for alerts string majorBullLine = â€œBULL Score:â€ +
mb_majorScore + â€ (â€ + str.tostring(mb_majorPct, â€œ#.##â€) + â€œ%)â€

// ===================================================== // ğŸŸ¦ DAILY
MARUBOZU SCORE (TF-LOCKED, ALWAYS VISIBLE) //
=====================================================

// â€” HTF DAILY candle (ISOLATED NAMES â€” NO COLLISION) [dO_D, dH_D, dL_D,
dC_D] = request.security(syminfo.tickerid,â€œDâ€,[open, high, low,
close],barmerge.gaps_off,barmerge.lookahead_off)

// â€” Candle geometry float dRange = math.max(dH_D - dL_D,
syminfo.mintick) float dBody = dC_D - dO_D

float dBodyPct = dBody / dRange float dUpperWick = (dH_D - dC_D) /
dRange float dLowerWick = (dO_D - dL_D) / dRange

string dailyMaruScore = â€œNAâ€ float dailyMaruPct = dBodyPct * 100.0

// â€” Score logic (bullish only) if dC_D <= dO_D dailyMaruScore := â€œFâ€
else if dBodyPct >= 0.90 and dUpperWick <= 0.03 and dLowerWick <= 0.03
dailyMaruScore := â€œA+â€ else if dBodyPct >= 0.80 dailyMaruScore := â€œAâ€
else if dBodyPct >= 0.70 dailyMaruScore := â€œBâ€ else if dBodyPct >= 0.60
dailyMaruScore := â€œCâ€ else if dBodyPct >= 0.50 dailyMaruScore := â€œDâ€
else dailyMaruScore := â€œEâ€

// â€” Alert / display line string dailyMaruLine =â€œMARUBOZU:â€
+dailyMaruScore +â€ (â€ + str.tostring(dailyMaruPct, â€œ#.##â€) + â€œ%)â€

// ===================================================== // ğŸŸ¦ WEEKLY
MARUBOZU SCORE // =====================================================

[wO_D, wH_D, wL_D, wC_D] = request.security(syminfo.tickerid,â€œWâ€,[open,
high, low, close],barmerge.gaps_off,barmerge.lookahead_off) //[wO_D,
wH_D, wL_D, wC_D] = request.security(syminfo.tickerid,â€œWâ€,[open[1],
high[1], low[1], close[1]],barmerge.gaps_off,barmerge.lookahead_off)

float wRange = math.max(wH_D - wL_D, syminfo.mintick) float wBody =
wC_D - wO_D

float wBodyPct = wBody / wRange float wUpperWick = (wH_D - wC_D) /
wRange float wLowerWick = (wO_D - wL_D) / wRange

string weeklyMaruScore = â€œNAâ€ float weeklyMaruPct = wBodyPct * 100.0

if wC_D <= wO_D weeklyMaruScore := â€œFâ€ else if wBodyPct >= 0.90 and
wUpperWick <= 0.03 and wLowerWick <= 0.03 weeklyMaruScore := â€œA+â€ else
if wBodyPct >= 0.80 weeklyMaruScore := â€œAâ€ else if wBodyPct >= 0.70
weeklyMaruScore := â€œBâ€ else if wBodyPct >= 0.60 weeklyMaruScore := â€œCâ€
else if wBodyPct >= 0.50 weeklyMaruScore := â€œDâ€ else weeklyMaruScore :=
â€œEâ€

// ===================================================== // ğŸŸª MONTHLY
MARUBOZU SCORE // =====================================================

[mO_D, mH_D, mL_D, mC_D] = request.security(syminfo.tickerid,â€œMâ€,[open,
high, low, close],barmerge.gaps_off,barmerge.lookahead_off) //[mO_D,
mH_D, mL_D, mC_D] = request.security(syminfo.tickerid,â€œMâ€,[open[1],
high[1], low[1], close[1]],barmerge.gaps_off,barmerge.lookahead_off)

float mRange = math.max(mH_D - mL_D, syminfo.mintick) float mBody =
mC_D - mO_D

float mBodyPct = mBody / mRange float mUpperWick = (mH_D - mC_D) /
mRange float mLowerWick = (mO_D - mL_D) / mRange

string monthlyMaruScore = â€œNAâ€ float monthlyMaruPct = mBodyPct * 100.0

if mC_D <= mO_D monthlyMaruScore := â€œFâ€ else if mBodyPct >= 0.90 and
mUpperWick <= 0.03 and mLowerWick <= 0.03 monthlyMaruScore := â€œA+â€ else
if mBodyPct >= 0.80 monthlyMaruScore := â€œAâ€ else if mBodyPct >= 0.70
monthlyMaruScore := â€œBâ€ else if mBodyPct >= 0.60 monthlyMaruScore := â€œCâ€
else if mBodyPct >= 0.50 monthlyMaruScore := â€œDâ€ else monthlyMaruScore
:= â€œEâ€

// ===================================================== // ğŸŸ§ YEARLY
MARUBOZU SCORE // =====================================================

[yO_D, yH_D, yL_D, yC_D] =
request.security(syminfo.tickerid,â€œ12Mâ€,[open, high, low,
close],barmerge.gaps_off,barmerge.lookahead_off) //[yO_D, yH_D, yL_D,
yC_D] = request.security(syminfo.tickerid,â€œ12Mâ€,[open[1], high[1],
low[1], close[1]],barmerge.gaps_off,barmerge.lookahead_off)

float yRange = math.max(yH_D - yL_D, syminfo.mintick) float yBody =
yC_D - yO_D

float yBodyPct = yBody / yRange float yUpperWick = (yH_D - yC_D) /
yRange float yLowerWick = (yO_D - yL_D) / yRange

string yearlyMaruScore = â€œNAâ€ float yearlyMaruPct = yBodyPct * 100.0

if yC_D <= yO_D yearlyMaruScore := â€œFâ€ else if yBodyPct >= 0.90 and
yUpperWick <= 0.03 and yLowerWick <= 0.03 yearlyMaruScore := â€œA+â€ else
if yBodyPct >= 0.80 yearlyMaruScore := â€œAâ€ else if yBodyPct >= 0.70
yearlyMaruScore := â€œBâ€ else if yBodyPct >= 0.60 yearlyMaruScore := â€œCâ€
else if yBodyPct >= 0.50 yearlyMaruScore := â€œDâ€ else yearlyMaruScore :=
â€œEâ€

// ===================================================== // ğŸŸ© ZZ
INTRADAY (SESSION-BASED) â€” v6 SAFE (FIXED) //
===================================================== string
dailyTrendScore = â€œNAâ€ float dailyTrendPct = na

string _trendScore = â€œâ€ float _trendPct = na

if not na(dC) [_trendScore, _trendPct] =
f_intradayTrend_from_AMPM(amTrendPct_last,pmTrendPct_last)

    dailyTrendScore := _trendScore
    dailyTrendPct   := _trendPct

// ===================================================== // ğŸ“© Alert
Lines // ===================================================== string
dailyTrendLine = â€œTREND Score:â€ + dailyTrendScore + â€ (â€ +
str.tostring(dailyTrendPct, â€œ#.##â€) + â€œ%)â€

// ===================== // ğŸ§  HUMAN-READABLE HELPERS (ALERT ONLY) //
=====================

// Price vs EMA text f_priceVsEMA(string emaName, float distPct) =>
na(distPct) ? emaName + â€œ: N/Aâ€ : distPct >= 0 ? â€œPrice >â€ + emaName + â€
(+â€ + str.tostring(distPct, â€œ#.##â€) + â€œ%)â€ : â€œPrice <â€ + emaName + â€
(â€ + str.tostring(distPct, â€œ#.##â€) + â€œ%)â€

// EMA Combo meaning f_emaComboText(float comboPct, string comboZone)
=>na(comboPct) ? â€œEMA Position: N/Aâ€ :â€œPrice > EMA20 & EMA50 (â€ +
str.tostring(comboPct, â€œ#.##â€) + â€œ%)â€ + comboZone

// ATR â†’ Entry Risk translation f_entryRisk(float atrCombo)
=>na(atrCombo) ? â€œBuy Risk: N/Aâ€ :atrCombo > 2.5 ? â€œBuy Risk: VERY HIGH
ğŸ”´ (Do NOT chase)â€ :atrCombo > 1.5 ? â€œBuy Risk: HIGH ğŸŸ  (Pullback
needed)â€ :atrCombo > 0.5 ? â€œBuy Risk: MEDIUM ğŸŸ¡ (Wait for pullback)â€
:â€œBuy Risk: LOW ğŸŸ¢ (Near value zone)â€

// ===================================================== // ğŸ“Š ZZ SCORE
TABLE (ON-CHART OVERLAY) //
===================================================== groupScoreTable =
â€œğŸ“Š ZZ Scoreboardâ€ // ===================== // ğŸ›ï¸ TABLE STYLE CONTROLS
// ===================== textTransp = input.int(0, â€œText Transparency (0
= Solid)â€, minval=0, maxval=100, group=groupScoreTable) bgTransp =
input.int(70, â€œRow Background Transparencyâ€, minval=0, maxval=100,
group=groupScoreTable) headerTransp = input.int(0, â€œHeader Background
Transparencyâ€, minval=0, maxval=100, group=groupScoreTable)

// ===================== // ğŸ¨ TABLE COLOR PICKERS //
===================== tblTextBaseCol = input.color(color.white, â€œTable
Text Colorâ€, group=groupScoreTable) tblRowBaseCol =
input.color(color.black, â€œRow Background Colorâ€, group=groupScoreTable)
tblHeaderBaseCol= input.color(color.black, â€œHeader Background Colorâ€,
group=groupScoreTable) // ===================== // ğŸ¨ HEADER TEXT STYLE
// ===================== tblHeaderTextBaseCol = input.color(color.white,
â€œHeader Text Colorâ€, group=groupScoreTable) headerTextTransp =
input.int(0, â€œHeader Text Transparencyâ€, minval=0, maxval=100,
group=groupScoreTable)

// ===================== // ğŸ“ TABLE POSITION MAP //
===================== tablePos = tablePositionInput == â€œTop Leftâ€ ?
position.top_left : tablePositionInput == â€œMiddle Rightâ€ ?
position.middle_right : tablePositionInput == â€œMiddle Leftâ€ ?
position.middle_left : tablePositionInput == â€œBottom Rightâ€?
position.bottom_right : tablePositionInput == â€œBottom Leftâ€ ?
position.bottom_left : position.top_right

// ===================== // ğŸ”  TABLE TEXT SIZE MAP //
===================== tblTextSize = tableTextSizeInput == â€œTinyâ€ ?
size.tiny : tableTextSizeInput == â€œSmallâ€ ? size.small :
tableTextSizeInput == â€œLargeâ€ ? size.large : size.normal

// ===================== // TABLE COLORS (DERIVED) //
===================== tblTextCol = color.new(tblTextBaseCol, textTransp)
tblBgCol = color.new(tblRowBaseCol, bgTransp) tblHeaderBg =
color.new(tblHeaderBaseCol, headerTransp) tblHeaderTextCol =
color.new(tblHeaderTextBaseCol, headerTextTransp)

// ===================== // ğŸ¨ UTC TEXT COLOR (TEXT ONLY) //
===================== color utcBullTextCol = utcBullScore >= 60 ?
color.lime : utcBullScore >= 40 ? color.yellow : color.rgb(255, 255,
255)

color utcBearTextCol = utcBearScore >= 60 ? color.red : utcBearScore >=
40 ? color.orange : color.rgb(255, 255, 255)

bullStateTxt = utcBullState bearStateTxt = dtcBearState

// ===================== // ğŸ¨ SCORE â†’ COLOR MAP (SAFE) //
===================== f_gradeColor(string grade) =>grade == â€œA+â€ or
grade == â€œAâ€ ? color.lime :grade == â€œBâ€ or grade == â€œCâ€ ? color.yellow :
grade == â€œDâ€ ? color.orange :color.red

// ===================== // ğŸ§  TABLE STATE TRACKER (v6 SAFE) //
===================== var bool _lastCompact = false var bool _firstRun =
true var string _lastTablePos = â€œâ€ var string _lastTextSize = â€œâ€ var
bool _lastDiagnostics = false

bool tableNeedsRebuild = _firstRun or _lastCompact != compactTable or
_lastTablePos != tablePositionInput or _lastTextSize !=
tableTextSizeInput or _lastDiagnostics != showDiagnostics

_lastCompact := compactTable _lastTablePos := tablePositionInput
_lastTextSize := tableTextSizeInput _lastDiagnostics := showDiagnostics
_firstRun := false

var table zzScoreTable = na

if na(zzScoreTable) or tableNeedsRebuild zzScoreTable :=
table.new(tablePos,2,compactTable ? 9 : (showDiagnostics ? 17 :
16),frame_color = color.new(color.gray, 40),frame_width = 1)

// ===================== // ğŸ“ SCORE TABLE ROW MAP (FIXED) //
=====================

// â€” Intraday & Phase Trends int ROW_INTRADAY_TREND = compactTable ? na
: 5 int ROW_AM_TREND = compactTable ? na : 6 int ROW_PM_TREND =
compactTable ? na : 7

// â€” Daily / Zones / Higher TF int ROW_DAILY_MARU = compactTable ? 5 : 8
int ROW_WEEKLY_MARU = compactTable ? na : 9 int ROW_MONTHLY_MARU =
compactTable ? na : 10 int ROW_YEARLY_MARU = compactTable ? na : 11 int
ROW_DIAGNOSTICS = compactTable ? na : (showDiagnostics ? 12 : na) int
ROW_UTC_BULL = compactTable ? 6 : (showDiagnostics ? 13 : 12) int
ROW_DTC_BEAR = compactTable ? 7 : (showDiagnostics ? 14 : 13) int
ROW_MAJOR_BULL = compactTable ? 8 : (showDiagnostics ? 15 : 14) int
ROW_TREND_STACK = compactTable ? na : (showDiagnostics ? 16 : 15)

// ===================================================== // ğŸ¨ GRADE â†’
COLOR (TIERED) // =====================================================
f_gradeTierColor(string grade) => switch grade â€œA+â€ => color.lime â€œAâ€ =>
color.lime â€œBâ€ => color.lime

        "C"  => color.yellow
        "D"  => color.yellow

        "E"  => color.red
        "F"  => color.red

        => color.gray

// ===================== // ğŸ¨ DYNAMIC SCORE COLORS //
=====================

color majorBullCol = f_gradeColor(mb_majorScore) color amTrendCol =
f_gradeColor(amTrendGrade) color pmTrendCol = f_gradeColor(pmTrendGrade)
// ===================================================== // ğŸ¨ GRADE â†’
COLOR (TIERED) // =====================================================

if ZZ_ON and showScoreTable and (barstate.islast or barstate.isfirst)
int lastRow = compactTable ? 8 : (showDiagnostics ? 16 : 15)
table.clear(zzScoreTable, 0, 0, 1, lastRow)

    // ---- HEADER
    table.cell(zzScoreTable, 0, 0, "ZZ SCOREBOARD", text_color = tblHeaderTextCol, bgcolor = tblHeaderBg, text_size = tblTextSize)
    table.cell(zzScoreTable, 1, 0, syminfo.ticker, text_color = tblHeaderTextCol, bgcolor = tblHeaderBg, text_size = tblTextSize)

    // ---- ANALYST CONSENSUS
    table.cell(zzScoreTable, 0, 1, "Consensus", text_color = tblTextCol, bgcolor = tblBgCol, text_size = tblTextSize)
    table.cell(zzScoreTable,1,1,str.tostring(consensusScore) + "% | " +(compactTable ? analystBreakdownCompact : analystBreakdown),text_color = tblTextCol,bgcolor    = tblBgCol, text_size = tblTextSize)

    // ---- MOMENTUM
    table.cell(zzScoreTable, 0, 2, "Momentum", text_color = tblTextCol, bgcolor = tblBgCol, text_size = tblTextSize)
    table.cell(zzScoreTable, 1, 2, str.tostring(bullScore) + "%", text_color = tblTextCol, bgcolor = tblBgCol, text_size = tblTextSize)

    // ---- EZP
    table.cell(zzScoreTable, 0, 3, "EZP Score", text_color = tblTextCol, bgcolor = tblBgCol, text_size = tblTextSize)
    table.cell(zzScoreTable, 1, 3, str.tostring(ezpScore) + "%", text_color = tblTextCol, bgcolor = tblBgCol, text_size = tblTextSize)

    table.cell(zzScoreTable, 0, 4, "EZP Rating", text_color = tblTextCol, bgcolor = tblBgCol, text_size = tblTextSize)
    table.cell(zzScoreTable, 1, 4, ezpRating, text_color = tblTextCol, bgcolor = tblBgCol, text_size = tblTextSize)

    // ---- INTRADAY (ONLY WHEN NOT COMPACT)
    if not na(ROW_INTRADAY_TREND)
        string intradayTxt =na(dailyTrendPct)? "NA": dailyTrendScore + " (" + str.tostring(dailyTrendPct, "#.##") + "%)"
        table.cell(zzScoreTable,0,ROW_INTRADAY_TREND,"Intraday Trend",text_color = tblTextCol,bgcolor    = tblBgCol,text_size  = tblTextSize)
        table.cell(zzScoreTable,1,ROW_INTRADAY_TREND,intradayTxt,text_color = f_gradeTierColor(dailyTrendScore),bgcolor    = tblBgCol,text_size  = tblTextSize)

    // ---- AM TREND
    if not na(ROW_AM_TREND)
        string amTxt = na(amTrendPct_last) ? "NA" : amTrendGrade_last + " (" + str.tostring(amTrendPct_last, "#.##") + "%)"
        table.cell(zzScoreTable,0,ROW_AM_TREND,"AM Trend",text_color = amTrendCol, bgcolor = tblBgCol, text_size = tblTextSize)
        table.cell(zzScoreTable,1,ROW_AM_TREND,amTxt, text_color = f_gradeTierColor(amTrendGrade_last), bgcolor = tblBgCol,text_size = tblTextSize)
        
    // ---- PM TREND
    if not na(ROW_PM_TREND)
        string pmTxt = na(pmTrendPct_last) ? "NA" : pmTrendGrade_last + " (" + str.tostring(pmTrendPct_last, "#.##") + "%)"
        table.cell(zzScoreTable,0,ROW_PM_TREND,"PM Trend",text_color = pmTrendCol, bgcolor = tblBgCol,text_size = tblTextSize)
        table.cell(zzScoreTable,1,ROW_PM_TREND,pmTxt,text_color = f_gradeTierColor(pmTrendGrade_last), bgcolor = tblBgCol,text_size = tblTextSize)
        
    // ---- UTC ZONE SCORES (NON-COMPACT ONLY)
    if not na(ROW_UTC_BULL)
        table.cell(zzScoreTable,0,ROW_UTC_BULL,"UTC Bull Zone",text_color = utcBullTextCol, bgcolor    = tblBgCol,   text_size  = tblTextSize)
        table.cell(zzScoreTable,1,ROW_UTC_BULL,str.tostring(utcBullScore) + "%" + bullStateTxt,text_color = utcBullTextCol,bgcolor    = tblBgCol,text_size  = tblTextSize)


    if not na(ROW_DTC_BEAR)
        table.cell(zzScoreTable,0,ROW_DTC_BEAR,"DTC Bear Zone",text_color = utcBearTextCol, bgcolor    = tblBgCol, text_size  = tblTextSize)
        table.cell(zzScoreTable,1,ROW_DTC_BEAR,str.tostring(utcBearScore) + "%" + bearStateTxt,text_color = utcBearTextCol, bgcolor    = tblBgCol, text_size  = tblTextSize)


    // ---- DAILY MARUBOZU
    if not na(ROW_DAILY_MARU)
        table.cell(zzScoreTable,0,ROW_DAILY_MARU,"Daily Marubozu",text_color = tblTextCol,bgcolor = tblBgCol,text_size = tblTextSize)
        table.cell(zzScoreTable,1,ROW_DAILY_MARU,dailyMaruScore + " (" + str.tostring(dailyMaruPct, "#.##") + "%)",text_color = f_gradeColor(dailyMaruScore),bgcolor = tblBgCol,text_size = tblTextSize)

    // ---- WEEKLY MARUBOZU
    if not na(ROW_WEEKLY_MARU)
        table.cell(zzScoreTable,0,ROW_WEEKLY_MARU,"Weekly Marubozu",text_color = tblTextCol,bgcolor = tblBgCol,text_size = tblTextSize)
        table.cell(zzScoreTable,1,ROW_WEEKLY_MARU,weeklyMaruScore + " (" + str.tostring(weeklyMaruPct, "#.##") + "%)",text_color = f_gradeColor(weeklyMaruScore),bgcolor = tblBgCol,text_size = tblTextSize)

// â€”- MONTHLY MARUBOZU if not na(ROW_MONTHLY_MARU)
table.cell(zzScoreTable,0,ROW_MONTHLY_MARU,â€œMonthly Marubozuâ€,text_color
= tblTextCol,bgcolor = tblBgCol,text_size = tblTextSize)
table.cell(zzScoreTable,1,ROW_MONTHLY_MARU,monthlyMaruScore + â€ (â€ +
str.tostring(monthlyMaruPct, â€œ#.##â€) + â€œ%)â€,text_color =
f_gradeColor(monthlyMaruScore),bgcolor = tblBgCol,text_size =
tblTextSize)

// â€”- YEARLY MARUBOZU if not na(ROW_YEARLY_MARU)
table.cell(zzScoreTable,0,ROW_YEARLY_MARU,â€œYearly Marubozuâ€,text_color =
tblTextCol,bgcolor = tblBgCol,text_size = tblTextSize)
table.cell(zzScoreTable,1,ROW_YEARLY_MARU,yearlyMaruScore + â€ (â€ +
str.tostring(yearlyMaruPct, â€œ#.##â€) + â€œ%)â€,text_color =
f_gradeColor(yearlyMaruScore),bgcolor = tblBgCol,text_size =
tblTextSize)

    if showDiagnostics and not na(ROW_DIAGNOSTICS)
        string diagnosticsTxt = "Type=" + marketType + " | Session=" + sessionLabel + " | Branch=" + market + " | ZZ=" + str.tostring(ZZ_ON) + " ELocked=" + str.tostring(e2soEntryLocked) + " RLocked=" + str.tostring(e2soReentryLocked) + " Exit=" + str.tostring(exitSignal) + " Pullback=" + str.tostring(pullbackCond)
        table.cell(zzScoreTable,0,ROW_DIAGNOSTICS,"Diagnostics",text_color = tblTextCol,bgcolor = tblBgCol,text_size = tblTextSize)
        table.cell(zzScoreTable,1,ROW_DIAGNOSTICS,diagnosticsTxt,text_color = tblTextCol,bgcolor = tblBgCol,text_size = tblTextSize)


    // ---- MAJOR BULL (ALWAYS SHOWN)
    if not na(ROW_MAJOR_BULL)
        table.cell(zzScoreTable,0,ROW_MAJOR_BULL,"Major BULL",text_color = tblTextCol,bgcolor = tblBgCol,text_size = tblTextSize)
        table.cell(zzScoreTable,1,ROW_MAJOR_BULL,mb_majorScore + " (" + str.tostring(mb_majorPct, "#.##") + "%)",text_color = majorBullCol,bgcolor = tblBgCol,text_size = tblTextSize)


    // ---- TREND STACK
    if not na(ROW_TREND_STACK)
        table.cell(zzScoreTable, 0, ROW_TREND_STACK, "Trend",text_color = tblTextCol,bgcolor = tblBgCol,text_size = tblTextSize)
        table.cell(zzScoreTable, 1, ROW_TREND_STACK, emaStackShort,text_color = tblTextCol,bgcolor = tblBgCol,text_size = tblTextSize)

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////Alerts Section
start here////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
=====================================================================================================================================
// ğŸš¨ E2Su ALERTS (HELPER) //
======================================================================================================================================

// ğŸŸ¢ E2Su ENTRY if e2suEntry and not e2suEntryLocked lastBar_E2Su :=
f_fireAlert( true, alertSymbol + â€ | E2Su ğŸŸ©| ğŸŸ¢ ENTRYâ€ + alertHeader +
â€ â€ + complianceLabel + â€œâ€ + â€œEP:â€ + str.tostring(close) + â€ | SL: â€ +
str.tostring(stopLoss) + â€ | TP1: â€ + str.tostring(tp1) + â€ | TP2: â€ +
str.tostring(tp2) + â€ | TP3: â€ + str.tostring(tp3) + â€ | TF: â€ +
timeframe.period + â€ | Trade: â€ + riskLabel + â€ | Triggered: â€ +
alertTime + â€œâ€ + â€œAnalyst Buy:â€ + recBuy + â€ | Strong.Buy: â€ +
recBuyStrong + â€ | Hold: â€ + recHold + â€ (â€ + recTotal + â€œ)â€ +
â€œConsensus:â€ + str.tostring(consensusScore) + â€œ/100â€ + consensusLabel +
â€œâ€ + â€œMomentum:â€ + momentumScore + â€œâ€ + â€œVol.state:â€ + pviStatus + â€ |
â€ + osobStatus + â€ | â€ + obvStatus + â€œâ€ + â€œTrend:â€ + emaStackShort +
â€œâ€ + â€œEZPScore:â€ + str.tostring(ezpScore) + â€œ/100â€ + ezpRating + â€œâ€ +
dailyTrendLine + dailyMaruLine + majorBullLine + â€œâ€ + â€œTags:â€ +
ezpTags + â€œâ€ + â€œğŸ”—â€ + chartLink, lastBar_E2Su )

    e2suEntryLocked := true
    highPriorityAlertFired := true

// ğŸ”´ E2Su EXIT if e2suExit and e2suEntryLocked lastBar_E2Su
:=f_fireAlert( true, alertSymbol + â€ | E2Su ğŸŸ©| ğŸ”´ EXIT â›”â€ +
alertHeader + â€ â€ + complianceLabel + â€œâ€ + â€œEX.P:â€ +
str.tostring(close) + â€ | TF: â€ + timeframe.period + â€ | Triggered: â€ +
alertTime + â€œâ€ + â€œAnalyst Sell:â€ + recSell + â€ | Strong.Sell: â€ +
recSellStrong + â€ (â€ + recTotal + â€œ)â€ + â€œConsensus:â€ +
str.tostring(consensusScore) + â€œ/100â€ + consensusLabel + â€œâ€ +
â€œMomentum:â€ + momentumScore + â€œâ€ + â€œVol.state:â€ + pviStatus + â€ | â€ +
osobStatus + â€ | â€ + obvStatus + â€œâ€ + â€œTrend:â€ + emaStackShort + â€œâ€ +
â€œEZPScore:â€ + str.tostring(ezpScore) + â€œ/100â€ + ezpRating + â€œâ€ +
dailyTrendLine + dailyMaruLine + majorBullLine + â€œâ€ + â€œTags:â€ +
ezpTags + â€œâ€ + â€œğŸ”—â€ + chartLink, lastBar_E2Su )

    e2suEntryLocked := false
    highPriorityAlertFired := true

////////////////////////////////////////////////////// //////////// E2So
ALERTS ////////////////////////////
/////////////////////////////////////////////////////
e2soEntryAlertEnabled = ZZ_ON and showE2So and showEntry and
showAllSignals e2soReentryAlertEnabled = ZZ_ON and showE2So and
showReEntry and showAllSignals e2soExitAlertEnabled = ZZ_ON and showE2So
and showExit and showAllSignals

if e2soEntryAlertEnabled and entry and not e2soEntryLocked
lastBar_E2SoEntry :=f_fireAlert( true, alertSymbol + â€ | E2So â¬œ| ğŸŸ¢
ENTRYâ€ + alertHeader + â€ â€ + complianceLabel + â€œâ€ + â€œEP:â€ +
str.tostring(close) + â€ | SL: â€ + str.tostring(stopLoss) + â€ | TP1: â€ +
str.tostring(tp1) + â€ | TP2: â€ + str.tostring(tp2) + â€ | TP3: â€ +
str.tostring(tp3) + â€ | TF: â€ + timeframe.period + â€ | Trade: â€ +
riskLabel + â€ | Triggered: â€ + alertTime + â€œâ€ + â€œAnalyst Buy:â€ +
recBuy + â€ | Strong.Buy: â€ + recBuyStrong + â€ | Hold: â€ + recHold + â€
(â€ + recTotal + â€œ)â€ + â€œConsensus:â€ + str.tostring(consensusScore) +
â€œ/100â€ + consensusLabel + â€œâ€ + â€œMomentum:â€ + momentumScore + â€œâ€ +
â€œVol.state:â€ + pviStatus + â€ | â€ + osobStatus + â€ | â€ + obvStatus + â€œâ€ +
â€œTrend:â€ + emaStackShort + â€œâ€ + â€œEZPScore:â€ + str.tostring(ezpScore) +
â€œ/100â€ + ezpRating + â€œâ€ + dailyTrendLine + dailyMaruLine +
majorBullLine + â€œâ€ + â€œTags:â€ + ezpTags + â€œâ€ + â€œğŸ”—â€ + chartLink,
lastBar_E2SoEntry )

    e2soEntryLocked := true
    highPriorityAlertFired := true

if e2soReentryAlertEnabled and e2soReentryState and not
e2soReentryLocked lastBar_E2SoReentry :=f_fireAlert( true, alertSymbol +
â€ | E2So â¬œ| ğŸŸ¢ REENTRY â™»ï¸â€ + alertHeader + â€ â€ + complianceLabel + â€œâ€ +
â€œEP:â€ + str.tostring(close) + â€ | SL: â€ + str.tostring(stopLoss) + â€ |
TP1: â€ + str.tostring(tp1) + â€ | TP2: â€ + str.tostring(tp2) + â€ | TP3:
â€ + str.tostring(tp3) + â€ | TF: â€ + timeframe.period + â€ | Trade: â€ +
riskLabel + â€œâ€ + â€œTriggered:â€ + alertTime + â€œâ€ + â€œAnalyst Buy:â€ +
recBuy + â€ | Strong.Buy: â€ + recBuyStrong + â€ | Hold: â€ + recHold + â€
(â€ + recTotal + â€œ)â€ + â€œConsensus:â€ + str.tostring(consensusScore) +
â€œ/100â€ + consensusLabel + â€œâ€ + â€œMomentum:â€ + momentumScore + â€œâ€ +
â€œVol.state:â€ + pviStatus + â€ | â€ + osobStatus + â€ | â€ + obvStatus + â€œâ€ +
â€œTrend:â€ + emaStackShort + â€œâ€ + â€œEZPScore:â€ + str.tostring(ezpScore) +
â€œ/100â€ + ezpRating + â€œâ€ + dailyTrendLine + dailyMaruLine +
majorBullLine + â€œâ€ + â€œTags:â€ + ezpTags + â€œâ€ + â€œğŸ”—â€ + chartLink,
lastBar_E2SoReentry )

    e2soReentryLocked := true
    highPriorityAlertFired := true

if e2soExitAlertEnabled and exitSignal and e2soEntryLocked
lastBar_E2SoExit :=f_fireAlert( true, alertSymbol + â€ | E2So â¬œ| ğŸ”´ EXIT
â›”â€ + alertHeader + â€ â€ + complianceLabel + â€œâ€ + â€œEX.P:â€ +
str.tostring(close) + â€ | TF: â€ + timeframe.period + â€ | Triggered: â€ +
alertTime + â€œâ€ + â€œAnalyst Sell:â€ + recSell + â€ | Strong.Sell: â€ +
recSellStrong + â€ | (â€ + recTotal + â€œ)â€ + â€œConsensus:â€ +
str.tostring(consensusScore) + â€œ/100â€ + consensusLabel + â€œâ€ +
â€œMomentum:â€ + momentumScore + â€œâ€ + â€œVol.state:â€ + pviStatus + â€ | â€ +
osobStatus + â€ | â€ + obvStatus + â€œâ€ + â€œTrend:â€ + emaStackShort + â€œâ€ +
â€œEZPScore:â€ + str.tostring(ezpScore) + â€œ/100â€ + ezpRating + â€œâ€ +
dailyTrendLine + dailyMaruLine + majorBullLine + â€œâ€ + â€œTags:â€ +
ezpTags + â€œâ€ + â€œğŸ”—â€ + chartLink, lastBar_E2SoExit )

    e2soEntryLocked := false
    e2soReentryLocked := false
    e2soInTrade := false
    highPriorityAlertFired := true

// ===================================================== // ğŸš¨ IBO
ALERTS (HELPER) // =====================================================

iboEntryAlert = ZZ_ON and iboDD_ON and showAllSignals and iboEntry
iboExitAlert = ZZ_ON and iboDD_ON and showAllSignals and iboExit
iboEntryTag = iboBuy2 ? â€œBUY2â€ : iboBuy1 ? â€œBUY1â€ : â€œENTRYâ€

// ğŸŸ¢ IBO ENTRY if iboEntryAlert lastBar_IBO :=f_fireAlert( true,
alertSymbol + â€ | IBO ğŸŸ¦| ğŸŸ¢ ENTRY (â€ + iboEntryTag + â€œ)â€ +
alertHeader + â€ â€ + complianceLabel + â€œâ€ + â€œEP:â€ + str.tostring(close) +
â€ | SL: â€ + str.tostring(stopLoss) + â€ | TP1: â€ + str.tostring(tp1) + â€
| TP2: â€ + str.tostring(tp2) + â€ | TP3: â€ + str.tostring(tp3) + â€ | TF:
â€ + timeframe.period + â€ | Trade: â€ + riskLabel + â€ | Triggered: â€ +
alertTime + â€œâ€ + â€œAnalyst Buy:â€ + recBuy + â€ | Strong.Buy: â€ +
recBuyStrong + â€ | Hold: â€ + recHold + â€ (â€ + recTotal + â€œ)â€ +
â€œConsensus:â€ + str.tostring(consensusScore) + â€œ/100â€ + consensusLabel +
â€œâ€ + â€œMomentum:â€ + momentumScore + â€œâ€ + â€œVol.state:â€ + pviStatus + â€ |
â€ + osobStatus + â€ | â€ + obvStatus + â€œâ€ + â€œTrend:â€ + emaStackShort +
â€œâ€ + â€œEZPScore:â€ + str.tostring(ezpScore) + â€œ/100â€ + ezpRating + â€œâ€ +
dailyTrendLine + dailyMaruLine + majorBullLine + â€œâ€ + â€œTags:â€ +
ezpTags + â€œâ€ + â€œğŸ”—â€ + chartLink, lastBar_IBO ) alert_IBO := true
highPriorityAlertFired := true

// ğŸ”´ IBO EXIT if iboExitAlert lastBar_IBO :=f_fireAlert( true,
alertSymbol + â€ | IBO ğŸŸ¦| ğŸ”´ EXIT â›”â€ + alertHeader + â€ â€ +
complianceLabel + â€œâ€ + â€œEX.P:â€ + str.tostring(close) + â€ | TF: â€ +
timeframe.period + â€ | Triggered: â€ + alertTime + â€œâ€ + â€œAnalyst Sell:â€ +
recSell + â€ | Strong.Sell: â€ + recSellStrong + â€ (â€ + recTotal + â€œ)â€ +
â€œConsensus:â€ + str.tostring(consensusScore) + â€œ/100â€ + consensusLabel +
â€œâ€ + â€œMomentum:â€ + momentumScore + â€œâ€ + â€œVol.state:â€ + pviStatus + â€ |
â€ + osobStatus + â€ | â€ + obvStatus + â€œâ€ + â€œTrend:â€ + emaStackShort +
â€œâ€ + â€œEZPScore:â€ + str.tostring(ezpScore) + â€œ/100â€ + ezpRating + â€œâ€ +
dailyTrendLine + dailyMaruLine + majorBullLine + â€œâ€ + â€œTags:â€ +
ezpTags + â€œâ€ + â€œğŸ”—â€ + chartLink, lastBar_IBO ) alert_IBO := true
highPriorityAlertFired := true

// ===================================================== // ğŸš¨ ZZ CORE
ALERTS (HELPER) // =====================================================

// ğŸŸ¢ ZZ CORE ENTRY if zzCoreEntryVisible lastBar_ZZCore :=f_fireAlert(
true, alertSymbol + â€ | ZZ CORE ğŸŸ¥| ğŸŸ¢ ENTRYâ€ + alertHeader + â€ â€ +
complianceLabel + â€œâ€ + â€œEP:â€ + str.tostring(close) + â€ | SL: â€ +
str.tostring(stopLoss) + â€ | TP1: â€ + str.tostring(tp1) + â€ | TP2: â€ +
str.tostring(tp2) + â€ | TP3: â€ + str.tostring(tp3) + â€ | TF: â€ +
timeframe.period + â€ | Trade: â€ + riskLabel + â€ | Triggered: â€ +
alertTime + â€œâ€ + â€œAnalyst Buy:â€ + recBuy + â€ | Strong.Buy: â€ +
recBuyStrong + â€ | Hold: â€ + recHold + â€ (â€ + recTotal + â€œ)â€ +
â€œConsensus:â€ + str.tostring(consensusScore) + â€œ/100â€ + consensusLabel +
â€œâ€ + â€œMomentum:â€ + momentumScore + â€œâ€ + â€œVol.state:â€ + pviStatus + â€ |
â€ + osobStatus + â€ | â€ + obvStatus + â€œâ€ + â€œTrend:â€ + emaStackShort +
â€œâ€ + â€œEZPScore:â€ + str.tostring(ezpScore) + â€œ/100â€ + ezpRating + â€œâ€ +
dailyTrendLine + dailyMaruLine + majorBullLine + â€œâ€ + â€œTags:â€ +
ezpTags + â€œâ€ + â€œğŸ”—â€ + chartLink, lastBar_ZZCore ) highPriorityAlertFired
:= true

// ğŸŸ¡ ZZ CORE RE-ENTRY if zzCoreReEntryVisible lastBar_ZZCore
:=f_fireAlert( true, alertSymbol + â€ | ZZ CORE ğŸŸ¥| ğŸŸ¡ REENTRY â™»ï¸â€ +
alertHeader + â€ â€ + complianceLabel + â€œâ€ + â€œEP:â€ + str.tostring(close) +
â€ | SL: â€ + str.tostring(stopLoss) + â€ | TP1: â€ + str.tostring(tp1) + â€
| TP2: â€ + str.tostring(tp2) + â€ | TP3: â€ + str.tostring(tp3) + â€ | TF:
â€ + timeframe.period + â€ | Trade: â€ + riskLabel + â€ | Triggered: â€ +
alertTime + â€œâ€ + â€œAnalyst Buy:â€ + recBuy + â€ | Strong.Buy: â€ +
recBuyStrong + â€ | Hold: â€ + recHold + â€ (â€ + recTotal + â€œ)â€ +
â€œConsensus:â€ + str.tostring(consensusScore) + â€œ/100â€ + consensusLabel +
â€œâ€ + â€œMomentum:â€ + momentumScore + â€œâ€ + â€œVol.state:â€ + pviStatus + â€ |
â€ + osobStatus + â€ | â€ + obvStatus + â€œâ€ + â€œTrend:â€ + emaStackShort +
â€œâ€ + â€œEZPScore:â€ + str.tostring(ezpScore) + â€œ/100â€ + ezpRating + â€œâ€ +
dailyTrendLine + dailyMaruLine + majorBullLine + â€œâ€ + â€œTags:â€ +
ezpTags + â€œâ€ + â€œğŸ”—â€ + chartLink, lastBar_ZZCore ) highPriorityAlertFired
:= true

// ğŸ”´ ZZ CORE EXIT if zzCoreExitVisible lastBar_ZZCore :=f_fireAlert(
true, alertSymbol + â€ | ZZ CORE ğŸŸ¥| ğŸ”´ EXIT â›”â€ + alertHeader + â€ â€ +
complianceLabel + â€œâ€ + â€œEX.P:â€ + str.tostring(close) + â€ | TF: â€ +
timeframe.period + â€ | Triggered: â€ + alertTime + â€œâ€ + â€œAnalyst Sell:â€ +
recSell + â€ | Strong.Sell: â€ + recSellStrong + â€ (â€ + recTotal + â€œ)â€ +
â€œConsensus:â€ + str.tostring(consensusScore) + â€œ/100â€ + consensusLabel +
â€œâ€ + â€œMomentum:â€ + momentumScore + â€œâ€ + â€œVol.state:â€ + pviStatus + â€ |
â€ + osobStatus + â€ | â€ + obvStatus + â€œâ€ + â€œTrend:â€ + emaStackShort +
â€œâ€ + â€œEZPScore:â€ + str.tostring(ezpScore) + â€œ/100â€ + ezpRating + â€œâ€ +
dailyTrendLine + dailyMaruLine + majorBullLine + â€œâ€ + â€œTags:â€ +
ezpTags + â€œâ€ + â€œğŸ”—â€ + chartLink, lastBar_ZZCore ) highPriorityAlertFired
:= true

// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€“ // ğŸš¨ ZZ MAJOR V2 ALERTS (HELPER) //
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€“

// ğŸŸ¢ ZZ MAJOR V2 â€” ENTRY if zzMajorV2EntryVisible lastBar_ZZMajor
:=f_fireAlert( true, alertSymbol + â€ | ZZ MAJOR V2 ğŸŸª| ğŸŸ¢ ENTRYâ€ +
alertHeader + â€ â€ + complianceLabel + â€œâ€ + â€œEP:â€ + str.tostring(close) +
â€ | SL: â€ + str.tostring(stopLoss) + â€ | TP1: â€ + str.tostring(tp1) + â€
| TP2: â€ + str.tostring(tp2) + â€ | TP3: â€ + str.tostring(tp3) + â€ | TF:
â€ + timeframe.period + â€ | Trade: â€ + riskLabel + â€ | Triggered: â€ +
alertTime + â€œâ€ + â€œAnalyst Buy:â€ + recBuy + â€ | Strong.Buy: â€ +
recBuyStrong + â€ | Hold: â€ + recHold + â€ (â€ + recTotal + â€œ)â€ +
â€œConsensus:â€ + str.tostring(consensusScore) + â€œâ€ + â€œMomentum:â€ +
momentumScore + â€œâ€ + â€œVol.state:â€ + pviStatus + â€ | â€ + osobStatus + â€ |
â€ + obvStatus + â€œâ€ + â€œTrend:â€ + emaStackShort + â€œâ€ + â€œEZPScore:â€ +
str.tostring(ezpScore) + â€œ/100â€ + ezpRating + â€œâ€ + dailyTrendLine +
dailyMaruLine + majorBullLine + â€œâ€ + â€œTags: #ZZMajorV2â€ + â€œğŸ”—â€ +
chartLink, lastBar_ZZMajor ) highPriorityAlertFired := true

// ğŸ”´ ZZ MAJOR V2 â€” EXIT (HIGHEST X) if zzMajorV2ExitVisible
lastBar_ZZMajor :=f_fireAlert( true, alertSymbol + â€ | ZZ MAJOR V2 ğŸŸª|
ğŸ”´ EXIT â›” (Highest X)â€ + alertHeader + â€ â€ + complianceLabel + â€œâ€ +
â€œEX.P:â€ + str.tostring(close) + â€ | TF: â€ + timeframe.period + â€ |
Triggered: â€ + alertTime + â€œâ€ + â€œAnalyst Sell:â€ + recSell + â€ |
Strong.Sell: â€ + recSellStrong + â€ (â€ + recTotal + â€œ)â€ + â€œConsensus:â€ +
str.tostring(consensusScore) + â€œ/100â€ + consensusLabel + â€œâ€ +
â€œMomentum:â€ + momentumScore + â€œâ€ + â€œVol.state:â€ + pviStatus + â€ | â€ +
osobStatus + â€ | â€ + obvStatus + â€œâ€ + â€œTrend:â€ + emaStackShort + â€œâ€ +
â€œEZPScore:â€ + str.tostring(ezpScore) + â€œ/100â€ + ezpRating + â€œâ€ +
dailyTrendLine + dailyMaruLine + majorBullLine + â€œâ€ + â€œTags: #ZZMajorV2
#HighestXâ€ + â€œğŸ”—â€ + chartLink, lastBar_ZZMajor ) highPriorityAlertFired
:= true

////////////////////////////////////////////////////// //////////// ZZ
MINOR ALERTS (HELPER) ////////////////
//////////////////////////////////////////////////////

// ğŸŸ¢ ZZ MINOR ENTRY if zzMinorEntryVisible lastBar_ZZMinor
:=f_fireAlert( true, alertSymbol + â€ | ZZ MINOR ğŸŸ¨| ğŸŸ¢ ENTRYâ€ +
alertHeader + â€ â€ + complianceLabel + â€œâ€ + â€œEP:â€ + str.tostring(close) +
â€ | SL: â€ + str.tostring(stopLoss) + â€ | TP1: â€ + str.tostring(tp1) + â€
| TP2: â€ + str.tostring(tp2) + â€ | TP3: â€ + str.tostring(tp3) + â€ | TF:
â€ + timeframe.period + â€ | Trade: â€ + riskLabel + â€ | Triggered: â€ +
alertTime + â€œâ€ + â€œAnalyst Buy:â€ + recBuy + â€ | Strong.Buy: â€ +
recBuyStrong + â€ | Hold: â€ + recHold + â€ (â€ + recTotal + â€œ)â€ +
â€œConsensus:â€ + str.tostring(consensusScore) + â€œ/100â€ + consensusLabel +
â€œâ€ + â€œMomentum:â€ + momentumScore + â€œâ€ + â€œVol.state:â€ + pviStatus + â€ |
â€ + osobStatus + â€ | â€ + obvStatus + â€œâ€ + â€œTrend:â€ + emaStackShort +
â€œâ€ + â€œEZPScore:â€ + str.tostring(ezpScore) + â€œ/100â€ + ezpRating + â€œâ€ +
dailyTrendLine + dailyMaruLine + majorBullLine + â€œâ€ + â€œTags:â€ +
ezpTags + â€œâ€ + â€œğŸ”—â€ + chartLink, lastBar_ZZMinor )
highPriorityAlertFired := true

// ğŸ”´ ZZ MINOR EXIT if zzMinorExitVisible lastBar_ZZMinor :=f_fireAlert(
true, alertSymbol + â€ | ZZ MINOR ğŸŸ¨| ğŸ”´ EXIT â›”â€ + alertHeader + â€ â€ +
complianceLabel + â€œâ€ + â€œEX.P:â€ + str.tostring(close) + â€ | TF: â€ +
timeframe.period + â€ | Triggered: â€ + alertTime + â€œâ€ + â€œAnalyst Sell:â€ +
recSell + â€ | Strong.Sell: â€ + recSellStrong + â€ (â€ + recTotal + â€œ)â€ +
â€œConsensus:â€ + str.tostring(consensusScore) + â€œ/100â€ + consensusLabel +
â€œâ€ + â€œMomentum:â€ + momentumScore + â€œâ€ + â€œVol.state:â€ + pviStatus + â€ |
â€ + osobStatus + â€ | â€ + obvStatus + â€œâ€ + â€œTrend:â€ + emaStackShort +
â€œâ€ + â€œEZPScore:â€ + str.tostring(ezpScore) + â€œ/100â€ + ezpRating + â€œâ€ +
dailyTrendLine + dailyMaruLine + majorBullLine + â€œâ€ + â€œTags:â€ +
ezpTags + â€œâ€ + â€œğŸ”—â€ + chartLink, lastBar_ZZMinor )
highPriorityAlertFired := true

// ===================================================== // ğŸŒ™ BTST_PRO
ALERTS (HELPER) // =====================================================

// ğŸŒ™ BTST GAP CONFIRMED (NEXT-DAY SETUP) if ezpBTST_GAP_OK lastBar_BTST
:=f_fireAlert( true, alertSymbol + â€ | Yesterday BTST ğŸŸª âœ” GAP
CONFIRMEDâ€ + alertHeader + â€ â€ + complianceLabel + â€œâ€ + â€œOpen â‰¥ Prev
Close âœ”â€ + â€œPrice Accepted âœ”â€ + â€œExit (Trigger):â€ +
str.tostring(btstEntryPrice) + â€ | Triggered: â€ + alertTime + â€œâ€ + â€ |
TF: â€ + timeframe.period + â€œâ€ + â€œVolume Confirmed âœ”â€ + â€œTrend:â€ +
emaStackShort + â€œâ€ + dailyTrendLine + dailyMaruLine + majorBullLine +
â€œâ€ + â€œTags:â€ + ezpTags + â€œâ€ + â€œğŸ“Œ ACTION:â€ + â€œâ€¢ Hold/Exit: Current /
Pullbackâ€ + â€œâ€¢ SL: Below Prev Closeâ€ + â€œâ€¢ Mode: Momentum Continuationâ€ +
â€œğŸ”—â€ + chartLink, lastBar_BTST ) highPriorityAlertFired := true

// ğŸŒ™ BTST_PRO ENTRY (INTRADAY TRIGGER) if ezpBTST_PRO lastBar_BTST
:=f_fireAlert( true, alertSymbol + â€ | BTST_PRO ğŸŸª(â€ + btstMarketLabel +
â€œ)â€ + alertHeader + â€ â€ + complianceLabel + â€œâ€ + â€œEntry (Trigger):â€ +
str.tostring(btstEntryPrice) + â€ | Triggered: â€ + alertTime + â€œâ€ + â€ |
TF: â€ + timeframe.period + â€œâ€ + â€ | MorningHigh: â€ +
str.tostring(btstMorningHigh) + â€œâ€ + â€œVol > MorningMax âœ” |
BuyPressure:â€ + bullBearLevel + â€œâ€ + â€œBullScore:â€ +
str.tostring(bullScore) + â€œ/100â€ + â€œPrice vs Moving Averages:â€ +
f_priceVsEMA(â€œEMA20â€, ema20DistPct) + â€œâ€ + f_priceVsEMA(â€œEMA50â€,
ema50DistPct) + â€œâ€ + f_emaComboText(emaComboDistPct, emaComboZone) +
â€œâ€ + â€œMarket Zones:â€ + â€œUTC Bull Zone:â€ + str.tostring(utcBullScore) +
â€œ% |â€ + utcBullState + â€œâ€ + â€œDTC Bear Zone:â€ +
str.tostring(utcBearScore) + â€œ% |â€ + dtcBearState + â€œâ€ + â€œTrade Risk:â€ +
f_entryRisk(emaATRCombo) + â€œâ€ + â€œTrend:â€ + emaStackShort + â€œâ€ +
dailyTrendLine + dailyMaruLine + majorBullLine + â€œâ€ + â€œTags:â€ +
ezpTags + â€œâ€ + â€œğŸ“Œ PLAN:â€ + â€œâ€¢ Entry:â€ + str.tostring(btstEntryPrice) +
â€ (Trigger Price)â€ + â€œâ€¢ SL: Below Morning Highâ€ + â€œâ€¢ Bias: Overnight
Holdâ€ + â€œğŸ”—â€ + chartLink, lastBar_BTST ) highPriorityAlertFired := true

// ===================================================== // ğŸš¨ UTC / DTC
ALERTS (HELPER) // =====================================================

// ğŸŸ¢ UTC â€” BULLISH CROSS if utcBuy and not alert_UTC_Cross and not
highPriorityAlertFired lastBar_UTC :=f_fireAlert( true, alertSymbol + â€
| UTC | ğŸŸ¢ BULLISH CROSSâ€ + alertHeader + â€œâ€ + â€œPrice:â€ +
str.tostring(close) + â€œâ€ + â€œTF:â€ + timeframe.period + â€ | Triggered: â€ +
alertTime + â€œâ€ +

            "Price vs Moving Averages:\n" +
            f_priceVsEMA("EMA20", ema20DistPct) + "\n" +
            f_priceVsEMA("EMA50", ema50DistPct) + "\n" +
            f_emaComboText(emaComboDistPct, emaComboZone) + "\n\n" +

            "Market Zones:\n" +
            "UTC Bull Zone: " + str.tostring(utcBullScore) + "% | " + utcBullState + "\n" +
            "DTC Bear Zone: " + str.tostring(utcBearScore) + "% | " + dtcBearState + "\n\n" +

            "Trade Risk:\n" +
            f_entryRisk(emaATRCombo) + "\n\n" +

            "Trend:\n" +
            "Trend: " + emaStackShort + "\n" +
            dailyTrendLine + dailyMaruLine + majorBullLine + "\n\n" +

            "ğŸ”— " + chartLink,
            lastBar_UTC
    )
    alert_UTC_Cross := true

// ğŸ”´ DTC â€” BEARISH CROSS if dtcSell and not alert_UTC_Cross and not
highPriorityAlertFired lastBar_UTC :=f_fireAlert( true, alertSymbol + â€
| DTC | ğŸ”´ BEARISH CROSSâ€ + alertHeader + â€œâ€ + â€œPrice:â€ +
str.tostring(close) + â€œâ€ + â€œTF:â€ + timeframe.period + â€ | Triggered: â€ +
alertTime + â€œâ€ +

            "Price vs Moving Averages:\n" +
            f_priceVsEMA("EMA20", ema20DistPct) + "\n" +
            f_priceVsEMA("EMA50", ema50DistPct) + "\n" +
            f_emaComboText(emaComboDistPct, emaComboZone) + "\n\n" +

            "Market Zones:\n" +
            "UTC Bull Zone: " + str.tostring(utcBullScore) + "% | " + utcBullState + "\n" +
            "DTC Bear Zone: " + str.tostring(utcBearScore) + "% | " + dtcBearState + "\n\n" +

            "Trade Risk:\n" +
            f_entryRisk(emaATRCombo) + "\n\n" +

            "Trend:\n" +
            "Trend: " + emaStackShort + "\n" +
            dailyTrendLine + dailyMaruLine + majorBullLine + "\n\n" +

            "ğŸ”— " + chartLink,
            lastBar_UTC
    )

// ğŸŸ¡ UTC â€” BEAR WEAKENING if utcBearWeakening and not alert_UTC_Entry
and not highPriorityAlertFired lastBar_UTC :=f_fireAlert( true,
alertSymbol + â€ | UTC | ğŸŸ¡ Bear Weakeningâ€ + alertHeader + â€œâ€ +
â€œPrice:â€ + str.tostring(close) + â€œâ€ + â€œTF:â€ + timeframe.period + â€ |
Triggered: â€ + alertTime + â€œâ€ +

            "Price vs Moving Averages:\n" +
            f_priceVsEMA("EMA20", ema20DistPct) + "\n" +
            f_priceVsEMA("EMA50", ema50DistPct) + "\n" +
            f_emaComboText(emaComboDistPct, emaComboZone) + "\n\n" +

            "Market Zones:\n" +
            "UTC Bull Zone: " + str.tostring(utcBullScore) + "% | " + utcBullState + "\n" +
            "DTC Bear Zone: " + str.tostring(utcBearScore) + "% | " + dtcBearState + "\n\n" +

            "Trade Risk:\n" +
            f_entryRisk(emaATRCombo) + "\n\n" +

            "Trend:\n" +
            "Trend: " + emaStackShort + "\n" +
            dailyTrendLine + dailyMaruLine + majorBullLine + "\n\n" +

            "ğŸ”— " + chartLink,
            lastBar_UTC
    )

// â™»ï¸ UTC â€” BULL ZONE CONTINUATION (RE-ENTRY) if utcReentry and not
alert_UTC_Reentry and not highPriorityAlertFired lastBar_UTC
:=f_fireAlert( true, alertSymbol + â€ | UTC | â™»ï¸ Bull Zone
Continuationâ€ + alertHeader + â€œâ€ + â€œPrice:â€ + str.tostring(close) + â€œâ€ +
â€œTF:â€ + timeframe.period + â€ | Triggered: â€ + alertTime + â€œâ€ +

            "Price vs Moving Averages:\n" +
            f_priceVsEMA("EMA20", ema20DistPct) + "\n" +
            f_priceVsEMA("EMA50", ema50DistPct) + "\n" +
            f_emaComboText(emaComboDistPct, emaComboZone) + "\n\n" +

            "Market Zones:\n" +
            "UTC Bull Zone: " + str.tostring(utcBullScore) + "% | " + utcBullState + "\n" +
            "DTC Bear Zone: " + str.tostring(utcBearScore) + "% | " + dtcBearState + "\n\n" +

            "Trade Risk:\n" +
            f_entryRisk(emaATRCombo) + "\n\n" +

            "Trend:\n" +
            "Trend: " + emaStackShort + "\n" +
            dailyTrendLine + dailyMaruLine + majorBullLine + "\n\n" +

            "ğŸ”— " + chartLink,
            lastBar_UTC
    )

// ğŸ”“ UTC LOCK RESET â€” when bull zone ends if not utcBullZone
alert_UTC_Entry := false

// ===================================================== // â° FCPO
EXPIRY ALERTS (CONFIRMED / NON-TRADING) //
=====================================================

// â° 7 DAYS TO EXPIRY alert_FCPO :=f_fireConfirmedAlert( fcpoExpiry7d
and barstate.isconfirmed and ta.change(time(â€œDâ€)) != 0, â€œâ° FCPO EXPIRY
WARNING (7 DAYS)â€ + fcpoDisplay + â€œâ€ + â€œContract expires inâ€ +
str.tostring(daysToExpiry) + â€ daysâ€ + â€œğŸ“Œ Action: Prepare rolloverâ€,
alert_FCPO )

// âš ï¸ 3 DAYS TO EXPIRY alert_FCPO :=f_fireConfirmedAlert( fcpoExpiry3d
and barstate.isconfirmed and ta.change(time(â€œDâ€)) != 0, â€œâš ï¸ FCPO EXPIRY
WARNING (3 DAYS)â€ + fcpoDisplay + â€œâ€ + â€œContract expires inâ€ +
str.tostring(daysToExpiry) + â€ daysâ€ + â€œğŸ“Œ Action: Reduce exposureâ€,
alert_FCPO )

// ğŸš¨ 1 DAY TO EXPIRY alert_FCPO :=f_fireConfirmedAlert( fcpoExpiry1d
and barstate.isconfirmed and ta.change(time(â€œDâ€)) != 0, â€œğŸš¨ FCPO EXPIRY
TOMORROWâ€ + fcpoDisplay + â€œâ€ + â€œFinal trading day approachingâ€ + â€œğŸ“Œ
Action: CLOSE or ROLLOVER NOWâ€, alert_FCPO )
